<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® R√©cup√©ration d'Urgence - R√©putaLink</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 15px; margin: 15px 0; border-radius: 5px; font-weight: bold; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { background: #dc3545; color: white; border: none; padding: 15px 30px; border-radius: 5px; cursor: pointer; margin: 10px; font-size: 16px; }
        button:hover { background: #c82333; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        .data-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .data-item { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 3px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® R√©cup√©ration d'Urgence des Donn√©es</h1>
        
        <div id="status" class="status info">
            Diagnostic en cours...
        </div>
        
        <div class="data-section">
            <h3>üîç Diagnostic des Donn√©es</h3>
            <div id="diagnostic-results"></div>
        </div>
        
        <div class="data-section">
            <h3>üíæ Donn√©es Trouv√©es</h3>
            <div id="found-data"></div>
        </div>
        
        <div class="data-section">
            <h3>üîÑ Actions de R√©cup√©ration</h3>
            <button onclick="scanAllData()">üîç Scanner Toutes les Donn√©es</button>
            <button onclick="recoverFromLocalStorage()">üíæ R√©cup√©rer depuis localStorage</button>
            <button onclick="recoverFromSupabase()">‚òÅÔ∏è R√©cup√©rer depuis Supabase</button>
            <button onclick="initializeDefaultData()" class="success">‚ö° Initialiser Donn√©es par D√©faut</button>
        </div>
        
        <div class="data-section">
            <h3>üìä R√©sultats de R√©cup√©ration</h3>
            <div id="recovery-results"></div>
        </div>
        
        <div class="data-section">
            <h3>üß™ Test de Fonctionnement</h3>
            <button onclick="testApplication()">üß™ Tester l'Application</button>
            <button onclick="goToMainApp()">üè† Aller √† l'Application</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-service.js"></script>
    
    <script>
        let foundProjects = [];
        let foundSites = [];
        let supabase = null;
        
        function log(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        function addDiagnostic(message) {
            const div = document.getElementById('diagnostic-results');
            const item = document.createElement('div');
            item.className = 'data-item';
            item.innerHTML = message;
            div.appendChild(item);
        }
        
        function addFoundData(title, data) {
            const div = document.getElementById('found-data');
            const section = document.createElement('div');
            section.innerHTML = `
                <h4>${title}</h4>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
            div.appendChild(section);
        }
        
        function addRecoveryResult(message) {
            const div = document.getElementById('recovery-results');
            const item = document.createElement('div');
            item.className = 'data-item';
            item.innerHTML = message;
            div.appendChild(item);
        }
        
        async function scanAllData() {
            log('üîç Scan complet des donn√©es...', 'info');
            
            // Vider les r√©sultats pr√©c√©dents
            document.getElementById('diagnostic-results').innerHTML = '';
            document.getElementById('found-data').innerHTML = '';
            
            // 1. V√©rifier localStorage
            addDiagnostic('<strong>üì± localStorage:</strong>');
            
            const projects = localStorage.getItem('ninjalinking-projects');
            const sites = localStorage.getItem('ninjalinking-sites');
            const user = localStorage.getItem('currentUser');
            const auth = localStorage.getItem('isAuthenticated');
            const supabaseUrl = localStorage.getItem('supabase-url');
            const supabaseKey = localStorage.getItem('supabase-anon-key');
            
            if (projects) {
                const projectsData = JSON.parse(projects);
                foundProjects = projectsData;
                addDiagnostic(`‚úÖ Projets trouv√©s: ${projectsData.length}`);
                addFoundData('Projets localStorage', projectsData);
            } else {
                addDiagnostic('‚ùå Aucun projet dans localStorage');
            }
            
            if (sites) {
                const sitesData = JSON.parse(sites);
                foundSites = sitesData;
                addDiagnostic(`‚úÖ Sites trouv√©s: ${sitesData.length}`);
                addFoundData('Sites localStorage', sitesData);
            } else {
                addDiagnostic('‚ùå Aucun site dans localStorage');
            }
            
            if (user) {
                addDiagnostic(`‚úÖ Utilisateur: ${user}`);
            } else {
                addDiagnostic('‚ùå Aucun utilisateur connect√©');
            }
            
            if (auth) {
                addDiagnostic(`‚úÖ Authentification: ${auth}`);
            } else {
                addDiagnostic('‚ùå Non authentifi√©');
            }
            
            if (supabaseUrl && supabaseKey) {
                addDiagnostic(`‚úÖ Supabase configur√©: ${supabaseUrl.substring(0, 30)}...`);
            } else {
                addDiagnostic('‚ùå Supabase non configur√©');
            }
            
            // 2. V√©rifier sessionStorage
            addDiagnostic('<strong>üì± sessionStorage:</strong>');
            const sessionKeys = Object.keys(sessionStorage);
            if (sessionKeys.length > 0) {
                addDiagnostic(`‚úÖ SessionStorage: ${sessionKeys.length} cl√©s`);
                sessionKeys.forEach(key => {
                    addDiagnostic(`  - ${key}: ${sessionStorage.getItem(key).substring(0, 50)}...`);
                });
            } else {
                addDiagnostic('‚ùå SessionStorage vide');
            }
            
            // 3. V√©rifier IndexedDB
            addDiagnostic('<strong>üóÑÔ∏è IndexedDB:</strong>');
            try {
                const databases = await indexedDB.databases();
                if (databases.length > 0) {
                    addDiagnostic(`‚úÖ IndexedDB: ${databases.length} bases`);
                    databases.forEach(db => {
                        addDiagnostic(`  - ${db.name}: ${db.version}`);
                    });
                } else {
                    addDiagnostic('‚ùå IndexedDB vide');
                }
            } catch (error) {
                addDiagnostic('‚ùå Erreur IndexedDB: ' + error.message);
            }
            
            // 4. V√©rifier Supabase
            if (supabaseUrl && supabaseKey) {
                addDiagnostic('<strong>‚òÅÔ∏è Supabase:</strong>');
                try {
                    supabase = createClient(supabaseUrl, supabaseKey);
                    const { data: projects, error: projectsError } = await supabase
                        .from('projects')
                        .select('*');
                    
                    if (projectsError) {
                        addDiagnostic(`‚ùå Erreur Supabase projets: ${projectsError.message}`);
                    } else {
                        addDiagnostic(`‚úÖ Projets Supabase: ${projects?.length || 0}`);
                        if (projects && projects.length > 0) {
                            addFoundData('Projets Supabase', projects);
                        }
                    }
                    
                    const { data: sites, error: sitesError } = await supabase
                        .from('sites')
                        .select('*');
                    
                    if (sitesError) {
                        addDiagnostic(`‚ùå Erreur Supabase sites: ${sitesError.message}`);
                    } else {
                        addDiagnostic(`‚úÖ Sites Supabase: ${sites?.length || 0}`);
                        if (sites && sites.length > 0) {
                            addFoundData('Sites Supabase', sites);
                        }
                    }
                } catch (error) {
                    addDiagnostic(`‚ùå Erreur connexion Supabase: ${error.message}`);
                }
            }
            
            log('‚úÖ Scan termin√©', 'success');
        }
        
        async function recoverFromLocalStorage() {
            log('üíæ R√©cup√©ration depuis localStorage...', 'info');
            
            try {
                const projects = localStorage.getItem('ninjalinking-projects');
                const sites = localStorage.getItem('ninjalinking-sites');
                
                if (projects) {
                    const projectsData = JSON.parse(projects);
                    localStorage.setItem('ninjalinking-projects', JSON.stringify(projectsData));
                    addRecoveryResult(`‚úÖ ${projectsData.length} projets r√©cup√©r√©s depuis localStorage`);
                } else {
                    addRecoveryResult('‚ùå Aucun projet trouv√© dans localStorage');
                }
                
                if (sites) {
                    const sitesData = JSON.parse(sites);
                    localStorage.setItem('ninjalinking-sites', JSON.stringify(sitesData));
                    addRecoveryResult(`‚úÖ ${sitesData.length} sites r√©cup√©r√©s depuis localStorage`);
                } else {
                    addRecoveryResult('‚ùå Aucun site trouv√© dans localStorage');
                }
                
                log('‚úÖ R√©cup√©ration localStorage termin√©e', 'success');
                
            } catch (error) {
                log('‚ùå Erreur r√©cup√©ration localStorage: ' + error.message, 'error');
                addRecoveryResult(`‚ùå Erreur: ${error.message}`);
            }
        }
        
        async function recoverFromSupabase() {
            log('‚òÅÔ∏è R√©cup√©ration depuis Supabase...', 'info');
            
            try {
                const supabaseUrl = localStorage.getItem('supabase-url');
                const supabaseKey = localStorage.getItem('supabase-anon-key');
                
                if (!supabaseUrl || !supabaseKey) {
                    addRecoveryResult('‚ùå Supabase non configur√©');
                    return;
                }
                
                supabase = createClient(supabaseUrl, supabaseKey);
                
                // R√©cup√©rer les projets
                const { data: projects, error: projectsError } = await supabase
                    .from('projects')
                    .select('*');
                
                if (projectsError) {
                    addRecoveryResult(`‚ùå Erreur projets Supabase: ${projectsError.message}`);
                } else {
                    if (projects && projects.length > 0) {
                        localStorage.setItem('ninjalinking-projects', JSON.stringify(projects));
                        addRecoveryResult(`‚úÖ ${projects.length} projets r√©cup√©r√©s depuis Supabase`);
                    } else {
                        addRecoveryResult('‚ùå Aucun projet dans Supabase');
                    }
                }
                
                // R√©cup√©rer les sites
                const { data: sites, error: sitesError } = await supabase
                    .from('sites')
                    .select('*');
                
                if (sitesError) {
                    addRecoveryResult(`‚ùå Erreur sites Supabase: ${sitesError.message}`);
                } else {
                    if (sites && sites.length > 0) {
                        localStorage.setItem('ninjalinking-sites', JSON.stringify(sites));
                        addRecoveryResult(`‚úÖ ${sites.length} sites r√©cup√©r√©s depuis Supabase`);
                    } else {
                        addRecoveryResult('‚ùå Aucun site dans Supabase');
                    }
                }
                
                log('‚úÖ R√©cup√©ration Supabase termin√©e', 'success');
                
            } catch (error) {
                log('‚ùå Erreur r√©cup√©ration Supabase: ' + error.message, 'error');
                addRecoveryResult(`‚ùå Erreur: ${error.message}`);
            }
        }
        
        function initializeDefaultData() {
            log('‚ö° Initialisation des donn√©es par d√©faut...', 'info');
            
            try {
                // Donn√©es par d√©faut pour les projets
                const defaultProjects = [
                    {
                        id: Date.now(),
                        name: 'Projet de R√©cup√©ration',
                        url: 'https://example.com',
                        objective: 'SEO',
                        traffic: 0,
                        trustFlow: 0,
                        ttf: 'Business',
                        referringDomains: 0,
                        keywords: ['r√©cup√©ration', 'test'],
                        spots: [],
                        budget: 0,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];
                
                // Donn√©es par d√©faut pour les sites
                const defaultSites = [
                    {
                        id: Date.now() + 1,
                        url: 'https://example-blog.com',
                        type: 'Blog',
                        theme: 'Business',
                        traffic: 10000,
                        trustFlow: 50,
                        ttf: 'Business',
                        follow: 'Oui',
                        notes: 'Site de r√©cup√©ration',
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: Date.now() + 2,
                        url: 'https://example-forum.com',
                        type: 'Forum',
                        theme: 'Technologie',
                        traffic: 5000,
                        trustFlow: 30,
                        ttf: 'Computers',
                        follow: 'Oui',
                        notes: 'Forum de r√©cup√©ration',
                        createdAt: new Date().toISOString()
                    }
                ];
                
                // Sauvegarder les donn√©es par d√©faut
                localStorage.setItem('ninjalinking-projects', JSON.stringify(defaultProjects));
                localStorage.setItem('ninjalinking-sites', JSON.stringify(defaultSites));
                
                addRecoveryResult(`‚úÖ ${defaultProjects.length} projet(s) par d√©faut cr√©√©(s)`);
                addRecoveryResult(`‚úÖ ${defaultSites.length} site(s) par d√©faut cr√©√©(s)`);
                
                log('‚úÖ Donn√©es par d√©faut initialis√©es', 'success');
                
            } catch (error) {
                log('‚ùå Erreur initialisation: ' + error.message, 'error');
                addRecoveryResult(`‚ùå Erreur: ${error.message}`);
            }
        }
        
        function testApplication() {
            log('üß™ Test de l\'application...', 'info');
            
            try {
                // V√©rifier que les donn√©es sont accessibles
                const projects = localStorage.getItem('ninjalinking-projects');
                const sites = localStorage.getItem('ninjalinking-sites');
                
                if (projects) {
                    const projectsData = JSON.parse(projects);
                    addRecoveryResult(`‚úÖ Test projets: ${projectsData.length} projet(s) accessible(s)`);
                } else {
                    addRecoveryResult('‚ùå Test projets: Aucun projet accessible');
                }
                
                if (sites) {
                    const sitesData = JSON.parse(sites);
                    addRecoveryResult(`‚úÖ Test sites: ${sitesData.length} site(s) accessible(s)`);
                } else {
                    addRecoveryResult('‚ùå Test sites: Aucun site accessible');
                }
                
                // Tester la navigation
                addRecoveryResult('‚úÖ Test navigation: Pr√™t');
                
                log('‚úÖ Tests termin√©s', 'success');
                
            } catch (error) {
                log('‚ùå Erreur tests: ' + error.message, 'error');
                addRecoveryResult(`‚ùå Erreur tests: ${error.message}`);
            }
        }
        
        function goToMainApp() {
            window.location.href = 'index.html?recovery=true&t=' + Date.now();
        }
        
        // Auto-scan au chargement
        window.addEventListener('load', () => {
            setTimeout(scanAllData, 1000);
        });
    </script>
</body>
</html>
