<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” Debug Sauvegarde Budget</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 15px; margin: 15px 0; border-radius: 5px; font-weight: bold; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { background: #007bff; color: white; border: none; padding: 15px 30px; border-radius: 5px; cursor: pointer; margin: 10px; font-size: 16px; }
        button:hover { background: #0056b3; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        .data-item { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 3px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
        .step { margin: 10px 0; padding: 15px; background: #e7f3ff; border-left: 4px solid #007bff; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Debug Sauvegarde Budget</h1>
        
        <div id="status" class="status info">
            Diagnostic de la sauvegarde du budget...
        </div>
        
        <div class="step">
            <h3>ğŸ” Ã‰tape 1 : VÃ©rifier la Structure</h3>
            <p>VÃ©rifions que la colonne budget existe et est accessible</p>
            <button onclick="checkBudgetColumn()">ğŸ” VÃ©rifier Colonne Budget</button>
            <div id="column-results"></div>
        </div>
        
        <div class="step">
            <h3>ğŸ“Š Ã‰tape 2 : VÃ©rifier les DonnÃ©es Existantes</h3>
            <p>Regardons les projets existants et leurs budgets</p>
            <button onclick="checkExistingProjects()">ğŸ“Š VÃ©rifier Projets Existants</button>
            <div id="projects-results"></div>
        </div>
        
        <div class="step">
            <h3>ğŸ§ª Ã‰tape 3 : Test de Sauvegarde</h3>
            <p>Testons la sauvegarde d'un projet avec budget</p>
            <button onclick="testBudgetSave()">ğŸ§ª Tester Sauvegarde</button>
            <div id="save-results"></div>
        </div>
        
        <div class="step">
            <h3>ğŸ”§ Ã‰tape 4 : Debug localStorage</h3>
            <p>VÃ©rifions les donnÃ©es dans localStorage</p>
            <button onclick="debugLocalStorage()">ğŸ”§ Debug localStorage</button>
            <div id="localstorage-results"></div>
        </div>
        
        <div class="step">
            <h3>ğŸ”„ Ã‰tape 5 : Test Complet</h3>
            <p>Test complet de crÃ©ation, sauvegarde et chargement</p>
            <button onclick="fullTest()" class="success">ğŸ”„ Test Complet</button>
            <div id="fulltest-results"></div>
        </div>
        
        <div id="results" style="margin-top: 20px;"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-service.js"></script>
    
    <script>
        let supabase = null;
        let db = null;
        
        function log(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        function addResult(containerId, message) {
            const container = document.getElementById(containerId);
            const item = document.createElement('div');
            item.className = 'data-item';
            item.innerHTML = message;
            container.appendChild(item);
        }
        
        async function initSupabase() {
            try {
                const defaultUrl = 'https://kckdjgedbjjuhmcqcmpe.supabase.co';
                const defaultKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtja2RqZ2VkYmpqdWhtY3FjbXBlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMjQzMzMsImV4cCI6MjA3MzcwMDMzM30.-TUGbwjk_8OUGZKJdnU5CqyJHI8wm4o1j1LdzRnSKhg';
                
                const supabaseUrl = localStorage.getItem('supabase-url') || defaultUrl;
                const supabaseKey = localStorage.getItem('supabase-anon-key') || defaultKey;
                
                supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                
                db = new SupabaseService();
                await db.initialize(supabaseUrl, supabaseKey);
                
                log('âœ… Supabase initialisÃ©', 'success');
                return true;
            } catch (error) {
                log('âŒ Erreur initialisation Supabase: ' + error.message, 'error');
                return false;
            }
        }
        
        async function checkBudgetColumn() {
            log('ğŸ” VÃ©rification de la colonne budget...', 'info');
            
            try {
                if (!supabase) {
                    await initSupabase();
                }
                
                // VÃ©rifier la structure de la table
                const { data: columns, error } = await supabase
                    .from('information_schema.columns')
                    .select('column_name, data_type, is_nullable, column_default')
                    .eq('table_name', 'projects')
                    .eq('column_name', 'budget');
                
                if (error) {
                    addResult('column-results', `âŒ Erreur: ${error.message}`);
                    log('âŒ Erreur vÃ©rification colonne', 'error');
                    return;
                }
                
                if (columns && columns.length > 0) {
                    const col = columns[0];
                    addResult('column-results', 'âœ… Colonne budget trouvÃ©e !');
                    addResult('column-results', `<strong>Type:</strong> ${col.data_type}`);
                    addResult('column-results', `<strong>Nullable:</strong> ${col.is_nullable}`);
                    addResult('column-results', `<strong>DÃ©faut:</strong> ${col.column_default || 'Aucun'}`);
                    log('âœ… Colonne budget vÃ©rifiÃ©e', 'success');
                } else {
                    addResult('column-results', 'âŒ Colonne budget non trouvÃ©e !');
                    log('âŒ Colonne budget manquante', 'error');
                }
                
            } catch (error) {
                addResult('column-results', `âŒ Erreur: ${error.message}`);
                log('âŒ Erreur vÃ©rification', 'error');
            }
        }
        
        async function checkExistingProjects() {
            log('ğŸ“Š VÃ©rification des projets existants...', 'info');
            
            try {
                if (!supabase) {
                    await initSupabase();
                }
                
                // RÃ©cupÃ©rer les projets avec budget
                const { data: projects, error } = await supabase
                    .from('projects')
                    .select('id, name, budget, created_at')
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) {
                    addResult('projects-results', `âŒ Erreur: ${error.message}`);
                    log('âŒ Erreur rÃ©cupÃ©ration projets', 'error');
                    return;
                }
                
                addResult('projects-results', `<h4>ğŸ“Š Projets trouvÃ©s (${projects.length}):</h4>`);
                
                if (projects && projects.length > 0) {
                    projects.forEach(project => {
                        const budgetDisplay = project.budget !== null ? `${project.budget} â‚¬` : 'Non dÃ©fini';
                        const style = project.budget !== null ? 'background: #d4edda;' : 'background: #fff3cd;';
                        addResult('projects-results', 
                            `<div style="${style} padding: 10px; margin: 5px 0; border-radius: 3px;">
                                <strong>${project.name}</strong> (ID: ${project.id})<br>
                                ğŸ’° Budget: ${budgetDisplay}<br>
                                ğŸ“… CrÃ©Ã©: ${new Date(project.created_at).toLocaleString()}
                            </div>`
                        );
                    });
                    log('âœ… Projets rÃ©cupÃ©rÃ©s', 'success');
                } else {
                    addResult('projects-results', 'âš ï¸ Aucun projet trouvÃ©');
                    log('âš ï¸ Aucun projet trouvÃ©', 'warning');
                }
                
            } catch (error) {
                addResult('projects-results', `âŒ Erreur: ${error.message}`);
                log('âŒ Erreur vÃ©rification projets', 'error');
            }
        }
        
        async function testBudgetSave() {
            log('ğŸ§ª Test de sauvegarde avec budget...', 'info');
            
            try {
                if (!db) {
                    await initSupabase();
                }
                
                // CrÃ©er un projet de test avec budget
                const testProject = {
                    name: 'Test Budget Debug ' + Date.now(),
                    url: 'https://test-budget-debug-' + Date.now() + '.com',
                    objective: 'SEO',
                    traffic: 1000,
                    trustFlow: 50,
                    ttf: 'Business',
                    referringDomains: 10,
                    publicationGoal: 5,
                    budget: 2500.75,
                    keywords: ['test', 'debug', 'budget'],
                    spots: []
                };
                
                addResult('save-results', '<h4>ğŸ§ª Projet de test:</h4>');
                addResult('save-results', `<pre>${JSON.stringify(testProject, null, 2)}</pre>`);
                
                // Tenter la sauvegarde via le service
                const result = await db.saveProject(testProject);
                
                if (result) {
                    addResult('save-results', 'âœ… Projet sauvegardÃ© avec succÃ¨s !');
                    addResult('save-results', `ğŸ“Š ID: ${result.id}`);
                    addResult('save-results', `ğŸ’° Budget sauvegardÃ©: ${result.budget} â‚¬`);
                    log('âœ… Test de sauvegarde rÃ©ussi', 'success');
                    
                    // VÃ©rifier immÃ©diatement en base
                    const { data: savedProject, error: fetchError } = await supabase
                        .from('projects')
                        .select('id, name, budget')
                        .eq('id', result.id)
                        .single();
                    
                    if (fetchError) {
                        addResult('save-results', `âš ï¸ Erreur vÃ©rification: ${fetchError.message}`);
                    } else {
                        addResult('save-results', `âœ… VÃ©rification en base: ${savedProject.budget} â‚¬`);
                    }
                    
                } else {
                    addResult('save-results', 'âŒ Ã‰chec de la sauvegarde');
                    log('âŒ Test de sauvegarde Ã©chouÃ©', 'error');
                }
                
            } catch (error) {
                addResult('save-results', `âŒ Erreur: ${error.message}`);
                log('âŒ Erreur test sauvegarde', 'error');
            }
        }
        
        function debugLocalStorage() {
            log('ğŸ”§ Debug localStorage...', 'info');
            
            try {
                const projects = localStorage.getItem('ninjalinking-projects');
                const sites = localStorage.getItem('ninjalinking-sites');
                const supabaseUrl = localStorage.getItem('supabase-url');
                const supabaseKey = localStorage.getItem('supabase-anon-key');
                const isAuth = localStorage.getItem('isAuthenticated');
                
                addResult('localstorage-results', '<h4>ğŸ“± localStorage:</h4>');
                addResult('localstorage-results', `<strong>Projets:</strong> ${projects ? 'PrÃ©sent' : 'Absent'}`);
                addResult('localstorage-results', `<strong>Sites:</strong> ${sites ? 'PrÃ©sent' : 'Absent'}`);
                addResult('localstorage-results', `<strong>Supabase URL:</strong> ${supabaseUrl || 'Non configurÃ©'}`);
                addResult('localstorage-results', `<strong>Supabase Key:</strong> ${supabaseKey ? 'ConfigurÃ©e' : 'Non configurÃ©e'}`);
                addResult('localstorage-results', `<strong>AuthentifiÃ©:</strong> ${isAuth || 'Non'}`);
                
                if (projects) {
                    const parsedProjects = JSON.parse(projects);
                    addResult('localstorage-results', `<h4>ğŸ“Š Projets dans localStorage (${parsedProjects.length}):</h4>`);
                    parsedProjects.forEach(project => {
                        const budgetDisplay = project.budget !== undefined ? `${project.budget} â‚¬` : 'Non dÃ©fini';
                        addResult('localstorage-results', 
                            `<div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 3px;">
                                <strong>${project.name}</strong><br>
                                ğŸ’° Budget: ${budgetDisplay}
                            </div>`
                        );
                    });
                }
                
                log('âœ… Debug localStorage terminÃ©', 'success');
                
            } catch (error) {
                addResult('localstorage-results', `âŒ Erreur: ${error.message}`);
                log('âŒ Erreur debug localStorage', 'error');
            }
        }
        
        async function fullTest() {
            log('ğŸ”„ Test complet en cours...', 'info');
            
            try {
                if (!db) {
                    await initSupabase();
                }
                
                addResult('fulltest-results', '<h4>ğŸ”„ Test complet:</h4>');
                
                // 1. CrÃ©er un projet avec budget
                const testProject = {
                    name: 'Test Complet Budget ' + Date.now(),
                    url: 'https://test-complet-' + Date.now() + '.com',
                    objective: 'SEO',
                    traffic: 2000,
                    trustFlow: 60,
                    ttf: 'Business',
                    referringDomains: 20,
                    publicationGoal: 10,
                    budget: 5000.00,
                    keywords: ['test', 'complet'],
                    spots: []
                };
                
                addResult('fulltest-results', '1ï¸âƒ£ CrÃ©ation du projet...');
                addResult('fulltest-results', `<pre>${JSON.stringify(testProject, null, 2)}</pre>`);
                
                // 2. Sauvegarder
                addResult('fulltest-results', '2ï¸âƒ£ Sauvegarde...');
                const savedProject = await db.saveProject(testProject);
                
                if (!savedProject) {
                    addResult('fulltest-results', 'âŒ Ã‰chec de la sauvegarde');
                    return;
                }
                
                addResult('fulltest-results', `âœ… Projet sauvegardÃ© (ID: ${savedProject.id})`);
                addResult('fulltest-results', `ğŸ’° Budget: ${savedProject.budget} â‚¬`);
                
                // 3. VÃ©rifier en base
                addResult('fulltest-results', '3ï¸âƒ£ VÃ©rification en base...');
                const { data: fetchedProject, error: fetchError } = await supabase
                    .from('projects')
                    .select('*')
                    .eq('id', savedProject.id)
                    .single();
                
                if (fetchError) {
                    addResult('fulltest-results', `âŒ Erreur rÃ©cupÃ©ration: ${fetchError.message}`);
                    return;
                }
                
                addResult('fulltest-results', `âœ… Projet rÃ©cupÃ©rÃ© de la base`);
                addResult('fulltest-results', `ğŸ’° Budget en base: ${fetchedProject.budget} â‚¬`);
                
                // 4. VÃ©rifier la cohÃ©rence
                if (savedProject.budget === fetchedProject.budget) {
                    addResult('fulltest-results', 'âœ… Budget cohÃ©rent entre sauvegarde et base');
                    log('âœ… Test complet rÃ©ussi', 'success');
                } else {
                    addResult('fulltest-results', 'âŒ Budget incohÃ©rent');
                    log('âŒ Test complet Ã©chouÃ©', 'error');
                }
                
            } catch (error) {
                addResult('fulltest-results', `âŒ Erreur: ${error.message}`);
                log('âŒ Erreur test complet', 'error');
            }
        }
        
        // Initialiser au chargement
        window.addEventListener('load', () => {
            setTimeout(initSupabase, 1000);
        });
    </script>
</body>
</html>

