<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Diagnostic et R√©paration</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 15px; margin: 15px 0; border-radius: 5px; font-weight: bold; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { background: #007bff; color: white; border: none; padding: 15px 30px; border-radius: 5px; cursor: pointer; margin: 10px; font-size: 16px; }
        button:hover { background: #0056b3; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        .data-item { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 3px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .critical { border-left: 5px solid #dc3545; background: #f8d7da; }
        .important { border-left: 5px solid #ffc107; background: #fff3cd; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Diagnostic et R√©paration</h1>
        
        <div id="status" class="status info">
            Diagnostic en cours...
        </div>
        
        <div class="test-section critical">
            <h3>üö® Diagnostic Complet</h3>
            <button onclick="runCompleteDiagnostic()" class="success">üîç Diagnostic Complet</button>
            <button onclick="fixAllIssues()" class="success">üîß R√©parer Tout</button>
            <div id="diagnostic-results"></div>
        </div>
        
        <div class="test-section">
            <h3>üß™ Tests de Validation</h3>
            <button onclick="testApplication()">üß™ Tester Application</button>
            <button onclick="goToMainApp()" class="success">üè† Aller √† l'App</button>
            <div id="test-results"></div>
        </div>
        
        <div id="results" style="margin-top: 20px;"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        function addResult(containerId, message) {
            const container = document.getElementById(containerId);
            const item = document.createElement('div');
            item.className = 'data-item';
            item.innerHTML = message;
            container.appendChild(item);
        }
        
        function runCompleteDiagnostic() {
            log('üîç Diagnostic complet en cours...', 'info');
            
            addResult('diagnostic-results', '<h4>üîç Diagnostic Complet:</h4>');
            
            // 1. V√©rifier les √©l√©ments DOM critiques
            addResult('diagnostic-results', '<h5>1. √âl√©ments DOM Critiques:</h5>');
            const criticalElements = [
                { id: 'homepage-container', name: 'Page d\'accueil' },
                { id: 'auth-container', name: 'Container d\'authentification' },
                { id: 'main-app', name: 'Interface principale' }
            ];
            
            criticalElements.forEach(element => {
                const el = document.getElementById(element.id);
                if (el) {
                    const isVisible = el.style.display !== 'none';
                    addResult('diagnostic-results', `‚úÖ ${element.name} (${element.id}): ${isVisible ? 'Visible' : 'Cach√©'}`);
                } else {
                    addResult('diagnostic-results', `‚ùå ${element.name} (${element.id}): Manquant`);
                }
            });
            
            // 2. V√©rifier les boutons de navigation
            addResult('diagnostic-results', '<h5>2. Boutons de Navigation:</h5>');
            const navButtons = document.querySelectorAll('.nav-btn');
            addResult('diagnostic-results', `Boutons trouv√©s: ${navButtons.length}`);
            
            if (navButtons.length > 0) {
                navButtons.forEach((btn, index) => {
                    const page = btn.dataset.page;
                    const isActive = btn.classList.contains('active');
                    addResult('diagnostic-results', `Bouton ${index + 1}: ${page} (${isActive ? 'Active' : 'Inactive'})`);
                });
            } else {
                addResult('diagnostic-results', '‚ùå Aucun bouton de navigation trouv√©');
            }
            
            // 3. V√©rifier les scripts charg√©s
            addResult('diagnostic-results', '<h5>3. Scripts JavaScript:</h5>');
            const scripts = document.querySelectorAll('script[src]');
            addResult('diagnostic-results', `Scripts charg√©s: ${scripts.length}`);
            
            scripts.forEach((script, index) => {
                const src = script.src;
                const isLoaded = script.readyState === 'complete' || script.readyState === 'loaded';
                addResult('diagnostic-results', `Script ${index + 1}: ${src.split('/').pop()} (${isLoaded ? 'Charg√©' : 'En cours'})`);
            });
            
            // 4. V√©rifier les fonctions critiques
            addResult('diagnostic-results', '<h5>4. Fonctions Critiques:</h5>');
            const criticalFunctions = [
                'initializeApp',
                'switchPage', 
                'loadData',
                'renderProjects',
                'checkAuthentication',
                'showMainInterface',
                'showHomepage'
            ];
            
            criticalFunctions.forEach(func => {
                const exists = typeof window[func] === 'function';
                addResult('diagnostic-results', `${func}: ${exists ? '‚úÖ' : '‚ùå'}`);
            });
            
            // 5. V√©rifier les variables globales
            addResult('diagnostic-results', '<h5>5. Variables Globales:</h5>');
            const globalVars = [
                'isAuthenticated',
                'currentUser',
                'db',
                'isSupabaseConfigured',
                'projects',
                'sites'
            ];
            
            globalVars.forEach(varName => {
                const exists = typeof window[varName] !== 'undefined';
                const value = window[varName];
                addResult('diagnostic-results', `${varName}: ${exists ? (value || 'D√©fini') : 'Non d√©fini'}`);
            });
            
            // 6. V√©rifier localStorage
            addResult('diagnostic-results', '<h5>6. localStorage:</h5>');
            const storageItems = [
                'isAuthenticated',
                'currentUser',
                'supabase-url',
                'supabase-anon-key',
                'ninjalinking-projects',
                'ninjalinking-sites'
            ];
            
            storageItems.forEach(item => {
                const value = localStorage.getItem(item);
                addResult('diagnostic-results', `${item}: ${value ? 'D√©fini' : 'Non d√©fini'}`);
            });
            
            log('‚úÖ Diagnostic termin√©', 'success');
        }
        
        function fixAllIssues() {
            log('üîß R√©paration de tous les probl√®mes...', 'info');
            
            addResult('diagnostic-results', '<h4>üîß R√©paration:</h4>');
            
            try {
                // 1. Nettoyer et r√©initialiser
                addResult('diagnostic-results', '1. Nettoyage et r√©initialisation...');
                localStorage.clear();
                addResult('diagnostic-results', '‚úÖ localStorage nettoy√©');
                
                // 2. R√©initialiser les variables globales
                addResult('diagnostic-results', '2. R√©initialisation des variables...');
                if (typeof window !== 'undefined') {
                    window.isAuthenticated = false;
                    window.currentUser = null;
                    window.db = null;
                    window.isSupabaseConfigured = false;
                    window.projects = [];
                    window.sites = [];
                }
                addResult('diagnostic-results', '‚úÖ Variables globales r√©initialis√©es');
                
                // 3. R√©initialiser l'interface
                addResult('diagnostic-results', '3. R√©initialisation de l\'interface...');
                const homepage = document.getElementById('homepage-container');
                const authContainer = document.getElementById('auth-container');
                const mainApp = document.getElementById('main-app');
                
                if (homepage) {
                    homepage.style.display = 'block';
                    addResult('diagnostic-results', '‚úÖ Page d\'accueil affich√©e');
                }
                
                if (authContainer) {
                    authContainer.style.display = 'none';
                    addResult('diagnostic-results', '‚úÖ Container d\'auth cach√©');
                }
                
                if (mainApp) {
                    mainApp.style.display = 'none';
                    addResult('diagnostic-results', '‚úÖ Interface principale cach√©e');
                }
                
                // 4. Recharger les scripts
                addResult('diagnostic-results', '4. Rechargement des scripts...');
                const scripts = ['ninja-linking-script.js', 'supabase-service.js'];
                scripts.forEach(script => {
                    const existingScript = document.querySelector(`script[src*="${script}"]`);
                    if (existingScript) {
                        existingScript.remove();
                    }
                    
                    const newScript = document.createElement('script');
                    newScript.src = script + '?v=' + Date.now();
                    newScript.onload = () => addResult('diagnostic-results', `‚úÖ ${script} recharg√©`);
                    newScript.onerror = () => addResult('diagnostic-results', `‚ùå Erreur chargement ${script}`);
                    document.head.appendChild(newScript);
                });
                
                // 5. Attendre et r√©initialiser
                addResult('diagnostic-results', '5. R√©initialisation finale...');
                setTimeout(() => {
                    if (typeof initializeApp === 'function') {
                        initializeApp();
                        addResult('diagnostic-results', '‚úÖ Application r√©initialis√©e');
                    }
                    
                    if (typeof setupAuthEventListeners === 'function') {
                        setupAuthEventListeners();
                        addResult('diagnostic-results', '‚úÖ Event listeners r√©initialis√©s');
                    }
                }, 3000);
                
                log('‚úÖ R√©paration termin√©e', 'success');
                
            } catch (error) {
                addResult('diagnostic-results', `‚ùå Erreur: ${error.message}`);
                log('‚ùå Erreur r√©paration', 'error');
            }
        }
        
        function testApplication() {
            log('üß™ Test de l\'application...', 'info');
            
            addResult('test-results', '<h4>üß™ Tests:</h4>');
            
            // 1. Test de l'initialisation
            addResult('test-results', '<h5>1. Test d\'Initialisation:</h5>');
            if (typeof initializeApp === 'function') {
                try {
                    initializeApp();
                    addResult('test-results', '‚úÖ Initialisation r√©ussie');
                } catch (error) {
                    addResult('test-results', `‚ùå Erreur initialisation: ${error.message}`);
                }
            } else {
                addResult('test-results', '‚ùå Fonction initializeApp non trouv√©e');
            }
            
            // 2. Test de la navigation
            addResult('test-results', '<h5>2. Test de Navigation:</h5>');
            if (typeof switchPage === 'function') {
                try {
                    switchPage('ninjalinking');
                    addResult('test-results', '‚úÖ Navigation r√©ussie');
                } catch (error) {
                    addResult('test-results', `‚ùå Erreur navigation: ${error.message}`);
                }
            } else {
                addResult('test-results', '‚ùå Fonction switchPage non trouv√©e');
            }
            
            // 3. Test des boutons
            addResult('test-results', '<h5>3. Test des Boutons:</h5>');
            const navButtons = document.querySelectorAll('.nav-btn');
            addResult('test-results', `Boutons trouv√©s: ${navButtons.length}`);
            
            if (navButtons.length > 0) {
                const testButton = navButtons[0];
                addResult('test-results', `Test clic sur: ${testButton.dataset.page}`);
                testButton.click();
                addResult('test-results', '‚úÖ Clic test√©');
            } else {
                addResult('test-results', '‚ùå Aucun bouton trouv√©');
            }
            
            log('‚úÖ Tests termin√©s', 'success');
        }
        
        function goToMainApp() {
            window.location.href = 'index.html';
        }
        
        // Auto-diagnostic au chargement
        window.addEventListener('load', () => {
            setTimeout(() => {
                runCompleteDiagnostic();
            }, 2000);
        });
    </script>
</body>
</html>
