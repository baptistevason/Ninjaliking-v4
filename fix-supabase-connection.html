<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß R√©paration Connexion Supabase</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 15px; margin: 15px 0; border-radius: 5px; font-weight: bold; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { background: #007bff; color: white; border: none; padding: 15px 30px; border-radius: 5px; cursor: pointer; margin: 10px; font-size: 16px; }
        button:hover { background: #0056b3; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        .config-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .data-item { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 3px; }
        input, textarea { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 3px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß R√©paration Connexion Supabase</h1>
        
        <div id="status" class="status info">
            Diagnostic de la connexion Supabase...
        </div>
        
        <div class="config-section">
            <h3>üîç Diagnostic de la Connexion</h3>
            <div id="diagnostic-results"></div>
            <button onclick="diagnoseConnection()">üîç Diagnostiquer la Connexion</button>
        </div>
        
        <div class="config-section">
            <h3>‚öôÔ∏è Configuration Supabase</h3>
            <p>Vos credentials Supabase par d√©faut :</p>
            <div class="data-item">
                <strong>URL :</strong> https://kckdjgedbjjuhmcqcmpe.supabase.co
            </div>
            <div class="data-item">
                <strong>Cl√© :</strong> eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtja2RqZ2VkYmpqdWhtY3FjbXBlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMjQzMzMsImV4cCI6MjA3MzcwMDMzM30.-TUGbwjk_8OUGZKJdnU5CqyJHI8wm4o1j1LdzRnSKhg
            </div>
            
            <h4>Configuration Personnalis√©e (optionnel)</h4>
            <input type="text" id="customUrl" placeholder="URL Supabase personnalis√©e" />
            <textarea id="customKey" placeholder="Cl√© Supabase personnalis√©e" rows="3"></textarea>
            <button onclick="configureCustomSupabase()">üîß Configurer Credentials Personnalis√©s</button>
        </div>
        
        <div class="config-section">
            <h3>üîÑ Actions de R√©paration</h3>
            <button onclick="restoreDefaultConnection()" class="success">‚ö° Restaurer Connexion par D√©faut</button>
            <button onclick="testConnection()">üß™ Tester la Connexion</button>
            <button onclick="reconnectSupabase()">üîÑ Reconnecter Supabase</button>
            <button onclick="clearSupabaseCache()">üóëÔ∏è Nettoyer Cache Supabase</button>
        </div>
        
        <div class="config-section">
            <h3>üìä R√©sultats des Tests</h3>
            <div id="test-results"></div>
        </div>
        
        <div class="config-section">
            <h3>üè† Retour √† l'Application</h3>
            <button onclick="goToMainApp()">üè† Aller √† l'Application</button>
            <button onclick="goToDataRecovery()">üö® R√©cup√©ration des Donn√©es</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-service.js"></script>
    
    <script>
        let supabase = null;
        
        function log(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        function addDiagnostic(message) {
            const div = document.getElementById('diagnostic-results');
            const item = document.createElement('div');
            item.className = 'data-item';
            item.innerHTML = message;
            div.appendChild(item);
        }
        
        function addTestResult(message) {
            const div = document.getElementById('test-results');
            const item = document.createElement('div');
            item.className = 'data-item';
            item.innerHTML = message;
            div.appendChild(item);
        }
        
        function diagnoseConnection() {
            log('üîç Diagnostic de la connexion Supabase...', 'info');
            
            // Vider les r√©sultats pr√©c√©dents
            document.getElementById('diagnostic-results').innerHTML = '';
            
            // 1. V√©rifier les credentials dans localStorage
            const storedUrl = localStorage.getItem('supabase-url');
            const storedKey = localStorage.getItem('supabase-anon-key');
            const isAuth = localStorage.getItem('isAuthenticated');
            const currentUser = localStorage.getItem('currentUser');
            
            addDiagnostic('<strong>üì± localStorage:</strong>');
            addDiagnostic(`URL: ${storedUrl || 'Non configur√©'}`);
            addDiagnostic(`Cl√©: ${storedKey ? storedKey.substring(0, 20) + '...' : 'Non configur√©'}`);
            addDiagnostic(`Authentifi√©: ${isAuth || 'Non'}`);
            addDiagnostic(`Utilisateur: ${currentUser || 'Aucun'}`);
            
            // 2. V√©rifier les variables globales
            addDiagnostic('<strong>üåê Variables globales:</strong>');
            addDiagnostic(`isSupabaseConfigured: ${typeof isSupabaseConfigured !== 'undefined' ? isSupabaseConfigured : 'Non d√©fini'}`);
            addDiagnostic(`isAuthenticated: ${typeof isAuthenticated !== 'undefined' ? isAuthenticated : 'Non d√©fini'}`);
            addDiagnostic(`db: ${typeof db !== 'undefined' ? (db ? 'Initialis√©' : 'Non initialis√©') : 'Non d√©fini'}`);
            
            // 3. V√©rifier la connexion r√©seau
            addDiagnostic('<strong>üåê Connexion r√©seau:</strong>');
            addDiagnostic(`En ligne: ${navigator.onLine ? 'Oui' : 'Non'}`);
            addDiagnostic(`User Agent: ${navigator.userAgent.substring(0, 50)}...`);
            
            log('‚úÖ Diagnostic termin√©', 'success');
        }
        
        async function restoreDefaultConnection() {
            log('‚ö° Restauration de la connexion par d√©faut...', 'info');
            
            try {
                // Credentials par d√©faut
                const defaultUrl = 'https://kckdjgedbjjuhmcqcmpe.supabase.co';
                const defaultKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtja2RqZ2VkYmpqdWhtY3FjbXBlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMjQzMzMsImV4cCI6MjA3MzcwMDMzM30.-TUGbwjk_8OUGZKJdnU5CqyJHI8wm4o1j1LdzRnSKhg';
                
                // Sauvegarder dans localStorage
                localStorage.setItem('supabase-url', defaultUrl);
                localStorage.setItem('supabase-anon-key', defaultKey);
                localStorage.setItem('supabase-configured', 'true');
                
                addTestResult('‚úÖ Credentials par d√©faut restaur√©s');
                
                // Tester la connexion
                await testConnection();
                
                log('‚úÖ Connexion par d√©faut restaur√©e', 'success');
                
            } catch (error) {
                log('‚ùå Erreur restauration: ' + error.message, 'error');
                addTestResult(`‚ùå Erreur: ${error.message}`);
            }
        }
        
        async function configureCustomSupabase() {
            const customUrl = document.getElementById('customUrl').value;
            const customKey = document.getElementById('customKey').value;
            
            if (!customUrl || !customKey) {
                addTestResult('‚ùå Veuillez remplir l\'URL et la cl√©');
                return;
            }
            
            log('üîß Configuration des credentials personnalis√©s...', 'info');
            
            try {
                localStorage.setItem('supabase-url', customUrl);
                localStorage.setItem('supabase-anon-key', customKey);
                localStorage.setItem('supabase-configured', 'true');
                
                addTestResult('‚úÖ Credentials personnalis√©s sauvegard√©s');
                
                // Tester la connexion
                await testConnection();
                
                log('‚úÖ Configuration personnalis√©e termin√©e', 'success');
                
            } catch (error) {
                log('‚ùå Erreur configuration: ' + error.message, 'error');
                addTestResult(`‚ùå Erreur: ${error.message}`);
            }
        }
        
        async function testConnection() {
            log('üß™ Test de la connexion Supabase...', 'info');
            
            try {
                const url = localStorage.getItem('supabase-url');
                const key = localStorage.getItem('supabase-anon-key');
                
                if (!url || !key) {
                    addTestResult('‚ùå Credentials Supabase manquants');
                    return;
                }
                
                // Cr√©er le client Supabase
                supabase = createClient(url, key);
                
                // Test de connexion basique
                const { data, error } = await supabase
                    .from('projects')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    addTestResult(`‚ùå Erreur connexion: ${error.message}`);
                    log('‚ùå Test de connexion √©chou√©', 'error');
                } else {
                    addTestResult('‚úÖ Connexion Supabase r√©ussie');
                    addTestResult(`üìä Donn√©es re√ßues: ${JSON.stringify(data)}`);
                    log('‚úÖ Test de connexion r√©ussi', 'success');
                }
                
            } catch (error) {
                addTestResult(`‚ùå Erreur test: ${error.message}`);
                log('‚ùå Erreur test de connexion: ' + error.message, 'error');
            }
        }
        
        async function reconnectSupabase() {
            log('üîÑ Reconnexion √† Supabase...', 'info');
            
            try {
                // Nettoyer les variables globales
                if (typeof window !== 'undefined') {
                    window.isSupabaseConfigured = false;
                    window.isAuthenticated = false;
                    window.db = null;
                    window.currentUser = null;
                }
                
                addTestResult('‚úÖ Variables globales nettoy√©es');
                
                // Recharger la page pour r√©initialiser
                addTestResult('üîÑ Rechargement de la page...');
                setTimeout(() => {
                    window.location.href = 'index.html?reconnect=true&t=' + Date.now();
                }, 2000);
                
            } catch (error) {
                log('‚ùå Erreur reconnexion: ' + error.message, 'error');
                addTestResult(`‚ùå Erreur: ${error.message}`);
            }
        }
        
        function clearSupabaseCache() {
            log('üóëÔ∏è Nettoyage du cache Supabase...', 'info');
            
            try {
                // Nettoyer localStorage
                localStorage.removeItem('supabase-url');
                localStorage.removeItem('supabase-anon-key');
                localStorage.removeItem('supabase-configured');
                localStorage.removeItem('isAuthenticated');
                localStorage.removeItem('currentUser');
                
                // Nettoyer sessionStorage
                sessionStorage.clear();
                
                addTestResult('‚úÖ Cache Supabase nettoy√©');
                addTestResult('‚úÖ localStorage nettoy√©');
                addTestResult('‚úÖ sessionStorage nettoy√©');
                
                log('‚úÖ Cache nettoy√©', 'success');
                
            } catch (error) {
                log('‚ùå Erreur nettoyage: ' + error.message, 'error');
                addTestResult(`‚ùå Erreur: ${error.message}`);
            }
        }
        
        function goToMainApp() {
            window.location.href = 'index.html?supabase-fixed=true&t=' + Date.now();
        }
        
        function goToDataRecovery() {
            window.location.href = 'emergency-data-recovery.html';
        }
        
        // Auto-diagnostic au chargement
        window.addEventListener('load', () => {
            setTimeout(diagnoseConnection, 1000);
        });
    </script>
</body>
</html>
