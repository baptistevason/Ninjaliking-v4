<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” VÃ©rification Colonne Budget</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 15px; margin: 15px 0; border-radius: 5px; font-weight: bold; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { background: #007bff; color: white; border: none; padding: 15px 30px; border-radius: 5px; cursor: pointer; margin: 10px; font-size: 16px; }
        button:hover { background: #0056b3; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        .data-item { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 3px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
        .step { margin: 10px 0; padding: 15px; background: #e7f3ff; border-left: 4px solid #007bff; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” VÃ©rification Colonne Budget</h1>
        
        <div id="status" class="status info">
            VÃ©rification de la colonne budget dans Supabase...
        </div>
        
        <div class="step">
            <h3>ğŸ” Ã‰tape 1 : VÃ©rifier la Structure de la Table</h3>
            <p>VÃ©rifions si la colonne budget existe dans la table projects</p>
            <button onclick="checkTableStructure()">ğŸ” VÃ©rifier Structure</button>
            <div id="structure-results"></div>
        </div>
        
        <div class="step">
            <h3>ğŸ”§ Ã‰tape 2 : Ajouter la Colonne Budget</h3>
            <p>Si la colonne n'existe pas, ajoutons-la</p>
            <button onclick="addBudgetColumn()" class="success">â• Ajouter Colonne Budget</button>
            <div id="add-column-results"></div>
        </div>
        
        <div class="step">
            <h3>ğŸ§ª Ã‰tape 3 : Tester la Sauvegarde</h3>
            <p>Testons la sauvegarde d'un projet avec budget</p>
            <button onclick="testBudgetSave()">ğŸ§ª Tester Sauvegarde Budget</button>
            <div id="test-results"></div>
        </div>
        
        <div class="step">
            <h3>ğŸ“Š Ã‰tape 4 : VÃ©rifier les DonnÃ©es</h3>
            <p>VÃ©rifions que les budgets sont bien sauvegardÃ©s</p>
            <button onclick="checkBudgetData()">ğŸ“Š VÃ©rifier DonnÃ©es Budget</button>
            <div id="data-results"></div>
        </div>
        
        <div id="results" style="margin-top: 20px;"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-service.js"></script>
    
    <script>
        let supabase = null;
        let db = null;
        
        function log(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        function addResult(containerId, message) {
            const container = document.getElementById(containerId);
            const item = document.createElement('div');
            item.className = 'data-item';
            item.innerHTML = message;
            container.appendChild(item);
        }
        
        async function initSupabase() {
            try {
                // Credentials par dÃ©faut
                const defaultUrl = 'https://kckdjgedbjjuhmcqcmpe.supabase.co';
                const defaultKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtja2RqZ2VkYmpqdWhtY3FjbXBlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMjQzMzMsImV4cCI6MjA3MzcwMDMzM30.-TUGbwjk_8OUGZKJdnU5CqyJHI8wm4o1j1LdzRnSKhg';
                
                const supabaseUrl = localStorage.getItem('supabase-url') || defaultUrl;
                const supabaseKey = localStorage.getItem('supabase-anon-key') || defaultKey;
                
                supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                
                // Initialiser le service
                db = new SupabaseService();
                await db.initialize(supabaseUrl, supabaseKey);
                
                log('âœ… Supabase initialisÃ©', 'success');
                return true;
            } catch (error) {
                log('âŒ Erreur initialisation Supabase: ' + error.message, 'error');
                return false;
            }
        }
        
        async function checkTableStructure() {
            log('ğŸ” VÃ©rification de la structure de la table...', 'info');
            
            try {
                if (!supabase) {
                    await initSupabase();
                }
                
                // VÃ©rifier la structure de la table projects
                const { data, error } = await supabase
                    .from('information_schema.columns')
                    .select('column_name, data_type, is_nullable, column_default')
                    .eq('table_name', 'projects')
                    .order('ordinal_position');
                
                if (error) {
                    addResult('structure-results', `âŒ Erreur: ${error.message}`);
                    log('âŒ Erreur vÃ©rification structure', 'error');
                    return;
                }
                
                addResult('structure-results', '<h4>ğŸ“Š Structure de la table projects:</h4>');
                data.forEach(col => {
                    const isBudget = col.column_name === 'budget';
                    const style = isBudget ? 'background: #d4edda; border-left: 4px solid #28a745;' : '';
                    addResult('structure-results', 
                        `<div style="${style}">
                            <strong>${col.column_name}</strong>: ${col.data_type} 
                            ${col.is_nullable === 'YES' ? '(nullable)' : '(not null)'} 
                            ${col.column_default ? `(dÃ©faut: ${col.column_default})` : ''}
                            ${isBudget ? ' âœ…' : ''}
                        </div>`
                    );
                });
                
                const hasBudget = data.some(col => col.column_name === 'budget');
                if (hasBudget) {
                    addResult('structure-results', 'âœ… Colonne budget trouvÃ©e !');
                    log('âœ… Structure vÃ©rifiÃ©e - colonne budget prÃ©sente', 'success');
                } else {
                    addResult('structure-results', 'âŒ Colonne budget manquante !');
                    log('âš ï¸ Structure vÃ©rifiÃ©e - colonne budget manquante', 'warning');
                }
                
            } catch (error) {
                addResult('structure-results', `âŒ Erreur: ${error.message}`);
                log('âŒ Erreur vÃ©rification', 'error');
            }
        }
        
        async function addBudgetColumn() {
            log('ğŸ”§ Ajout de la colonne budget...', 'info');
            
            try {
                if (!supabase) {
                    await initSupabase();
                }
                
                // Script SQL pour ajouter la colonne budget
                const sqlScript = `
                    -- Ajouter la colonne budget Ã  la table projects
                    ALTER TABLE projects 
                    ADD COLUMN budget DECIMAL(10,2) DEFAULT 0.00;
                    
                    -- Ajouter un index pour les performances
                    CREATE INDEX IF NOT EXISTS idx_projects_budget ON projects(budget) WHERE budget > 0;
                `;
                
                addResult('add-column-results', '<h4>ğŸ“ Script SQL Ã  exÃ©cuter:</h4>');
                addResult('add-column-results', `<pre>${sqlScript}</pre>`);
                
                addResult('add-column-results', '<h4>ğŸ“‹ Instructions:</h4>');
                addResult('add-column-results', '<ol>');
                addResult('add-column-results', '<li>Allez dans votre dashboard Supabase</li>');
                addResult('add-column-results', '<li>Ouvrez l\'Ã©diteur SQL</li>');
                addResult('add-column-results', '<li>Copiez et collez le script ci-dessus</li>');
                addResult('add-column-results', '<li>ExÃ©cutez le script</li>');
                addResult('add-column-results', '<li>Revenez ici et cliquez sur "VÃ©rifier Structure"</li>');
                addResult('add-column-results', '</ol>');
                
                log('ğŸ“ Script gÃ©nÃ©rÃ© - exÃ©cutez-le dans Supabase', 'info');
                
            } catch (error) {
                addResult('add-column-results', `âŒ Erreur: ${error.message}`);
                log('âŒ Erreur gÃ©nÃ©ration script', 'error');
            }
        }
        
        async function testBudgetSave() {
            log('ğŸ§ª Test de sauvegarde avec budget...', 'info');
            
            try {
                if (!db) {
                    await initSupabase();
                }
                
                // CrÃ©er un projet de test avec budget
                const testProject = {
                    name: 'Test Budget ' + Date.now(),
                    url: 'https://test-budget.com',
                    objective: 'SEO',
                    traffic: 1000,
                    trustFlow: 50,
                    ttf: 'Business',
                    referringDomains: 10,
                    publicationGoal: 5,
                    budget: 1500.50,
                    keywords: ['test', 'budget'],
                    spots: []
                };
                
                addResult('test-results', '<h4>ğŸ§ª Projet de test:</h4>');
                addResult('test-results', `<pre>${JSON.stringify(testProject, null, 2)}</pre>`);
                
                // Tenter la sauvegarde
                const result = await db.saveProject(testProject);
                
                if (result) {
                    addResult('test-results', 'âœ… Projet sauvegardÃ© avec succÃ¨s !');
                    addResult('test-results', `ğŸ“Š ID du projet: ${result.id}`);
                    addResult('test-results', `ğŸ’° Budget sauvegardÃ©: ${result.budget} â‚¬`);
                    log('âœ… Test de sauvegarde rÃ©ussi', 'success');
                } else {
                    addResult('test-results', 'âŒ Ã‰chec de la sauvegarde');
                    log('âŒ Test de sauvegarde Ã©chouÃ©', 'error');
                }
                
            } catch (error) {
                addResult('test-results', `âŒ Erreur: ${error.message}`);
                log('âŒ Erreur test sauvegarde', 'error');
            }
        }
        
        async function checkBudgetData() {
            log('ğŸ“Š VÃ©rification des donnÃ©es budget...', 'info');
            
            try {
                if (!supabase) {
                    await initSupabase();
                }
                
                // RÃ©cupÃ©rer les projets avec budget
                const { data, error } = await supabase
                    .from('projects')
                    .select('id, name, budget')
                    .not('budget', 'is', null)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    addResult('data-results', `âŒ Erreur: ${error.message}`);
                    log('âŒ Erreur rÃ©cupÃ©ration donnÃ©es', 'error');
                    return;
                }
                
                addResult('data-results', '<h4>ğŸ“Š Projets avec budget:</h4>');
                
                if (data && data.length > 0) {
                    data.forEach(project => {
                        addResult('data-results', 
                            `<div style="background: #d4edda; border-left: 4px solid #28a745; padding: 10px; margin: 5px 0;">
                                <strong>${project.name}</strong> (ID: ${project.id})<br>
                                ğŸ’° Budget: ${project.budget} â‚¬
                            </div>`
                        );
                    });
                    log(`âœ… ${data.length} projets avec budget trouvÃ©s`, 'success');
                } else {
                    addResult('data-results', 'âš ï¸ Aucun projet avec budget trouvÃ©');
                    log('âš ï¸ Aucune donnÃ©e budget trouvÃ©e', 'warning');
                }
                
            } catch (error) {
                addResult('data-results', `âŒ Erreur: ${error.message}`);
                log('âŒ Erreur vÃ©rification donnÃ©es', 'error');
            }
        }
        
        // Initialiser au chargement
        window.addEventListener('load', () => {
            setTimeout(initSupabase, 1000);
        });
    </script>
</body>
</html>
