<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔍 Analyse Complète</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 15px; margin: 15px 0; border-radius: 5px; font-weight: bold; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .critical { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-left: 5px solid #dc3545; }
        button { background: #007bff; color: white; border: none; padding: 15px 30px; border-radius: 5px; cursor: pointer; margin: 10px; font-size: 16px; }
        button:hover { background: #0056b3; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        .data-item { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 3px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .critical-section { border-left: 5px solid #dc3545; background: #f8d7da; }
        .important-section { border-left: 5px solid #ffc107; background: #fff3cd; }
        .analysis-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .analysis-card { background: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6; }
        .analysis-card h4 { margin-top: 0; color: #495057; }
        .metric { display: flex; justify-content: space-between; margin: 5px 0; }
        .metric-value { font-weight: bold; }
        .metric-good { color: #28a745; }
        .metric-warning { color: #ffc107; }
        .metric-error { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 Analyse Complète de l'Application</h1>
        
        <div id="status" class="status info">
            Diagnostic complet en cours...
        </div>
        
        <div class="test-section critical-section">
            <h3>🚨 Problèmes Critiques</h3>
            <button onclick="analyzeCriticalIssues()" class="danger">🔍 Analyser Problèmes Critiques</button>
            <div id="critical-results"></div>
        </div>
        
        <div class="test-section">
            <h3>📊 Analyse des Composants</h3>
            <div class="analysis-grid">
                <div class="analysis-card">
                    <h4>🏗️ Structure DOM</h4>
                    <button onclick="analyzeDOMStructure()">🔍 Analyser DOM</button>
                    <div id="dom-analysis"></div>
                </div>
                <div class="analysis-card">
                    <h4>🔧 Scripts JavaScript</h4>
                    <button onclick="analyzeJavaScript()">🔍 Analyser JS</button>
                    <div id="js-analysis"></div>
                </div>
                <div class="analysis-card">
                    <h4>🔐 Authentification</h4>
                    <button onclick="analyzeAuthentication()">🔍 Analyser Auth</button>
                    <div id="auth-analysis"></div>
                </div>
                <div class="analysis-card">
                    <h4>💾 Données</h4>
                    <button onclick="analyzeData()">🔍 Analyser Données</button>
                    <div id="data-analysis"></div>
                </div>
            </div>
        </div>
        
        <div class="test-section important-section">
            <h3>🔧 Tests de Fonctionnalités</h3>
            <button onclick="testCoreFunctionality()" class="success">🧪 Tester Fonctionnalités</button>
            <button onclick="testNavigation()">🧪 Tester Navigation</button>
            <button onclick="testAuthentication()">🧪 Tester Auth</button>
            <div id="functionality-results"></div>
        </div>
        
        <div class="test-section">
            <h3>📋 Rapport Complet</h3>
            <button onclick="generateCompleteReport()" class="success">📋 Générer Rapport</button>
            <button onclick="exportAnalysis()">📤 Exporter Analyse</button>
            <div id="report-results"></div>
        </div>
        
        <div id="results" style="margin-top: 20px;"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        function addResult(containerId, message) {
            const container = document.getElementById(containerId);
            const item = document.createElement('div');
            item.className = 'data-item';
            item.innerHTML = message;
            container.appendChild(item);
        }
        
        function analyzeCriticalIssues() {
            log('🚨 Analyse des problèmes critiques...', 'error');
            
            addResult('critical-results', '<h4>🚨 Problèmes Critiques Identifiés:</h4>');
            
            const criticalIssues = [];
            
            // 1. Vérifier les erreurs de console
            addResult('critical-results', '<h5>1. Erreurs de Console:</h5>');
            addResult('critical-results', 'Vérifiez la console du navigateur pour les erreurs JavaScript');
            
            // 2. Vérifier les scripts manquants
            addResult('critical-results', '<h5>2. Scripts JavaScript:</h5>');
            const requiredScripts = ['ninja-linking-script.js', 'supabase-service.js'];
            requiredScripts.forEach(script => {
                const scriptElement = document.querySelector(`script[src*="${script}"]`);
                if (scriptElement) {
                    addResult('critical-results', `✅ ${script} chargé`);
                } else {
                    addResult('critical-results', `❌ ${script} manquant`);
                    criticalIssues.push(`Script manquant: ${script}`);
                }
            });
            
            // 3. Vérifier les éléments DOM critiques
            addResult('critical-results', '<h5>3. Éléments DOM Critiques:</h5>');
            const criticalElements = [
                'homepage-container',
                'auth-container', 
                'main-interface',
                'projects-page',
                'catalog-page'
            ];
            
            criticalElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    addResult('critical-results', `✅ ${elementId} trouvé`);
                } else {
                    addResult('critical-results', `❌ ${elementId} manquant`);
                    criticalIssues.push(`Élément DOM manquant: ${elementId}`);
                }
            });
            
            // 4. Vérifier les fonctions critiques
            addResult('critical-results', '<h5>4. Fonctions Critiques:</h5>');
            const criticalFunctions = [
                'initializeApp',
                'setupAuthEventListeners',
                'switchPage',
                'loadData',
                'renderProjects'
            ];
            
            criticalFunctions.forEach(func => {
                if (typeof window[func] === 'function') {
                    addResult('critical-results', `✅ ${func} disponible`);
                } else {
                    addResult('critical-results', `❌ ${func} manquante`);
                    criticalIssues.push(`Fonction manquante: ${func}`);
                }
            });
            
            // 5. Résumé des problèmes critiques
            if (criticalIssues.length > 0) {
                addResult('critical-results', '<h5>🚨 Problèmes Critiques Détectés:</h5>');
                criticalIssues.forEach(issue => {
                    addResult('critical-results', `❌ ${issue}`);
                });
                log(`❌ ${criticalIssues.length} problèmes critiques détectés`, 'error');
            } else {
                addResult('critical-results', '✅ Aucun problème critique détecté');
                log('✅ Aucun problème critique', 'success');
            }
        }
        
        function analyzeDOMStructure() {
            log('🏗️ Analyse de la structure DOM...', 'info');
            
            addResult('dom-analysis', '<h4>🏗️ Structure DOM:</h4>');
            
            // 1. Vérifier les conteneurs principaux
            const mainContainers = [
                'homepage-container',
                'auth-container',
                'main-interface',
                'app'
            ];
            
            mainContainers.forEach(container => {
                const element = document.getElementById(container);
                if (element) {
                    const isVisible = element.style.display !== 'none';
                    addResult('dom-analysis', `${container}: ${isVisible ? 'Visible' : 'Caché'}`);
                } else {
                    addResult('dom-analysis', `${container}: ❌ Manquant`);
                }
            });
            
            // 2. Vérifier les pages
            const pages = [
                'ninjalinking-page',
                'projects-page',
                'catalog-page',
                'serp-page',
                'ereputation-page',
                'ia-page'
            ];
            
            addResult('dom-analysis', '<h5>📄 Pages:</h5>');
            pages.forEach(page => {
                const element = document.getElementById(page);
                if (element) {
                    const isActive = element.classList.contains('active');
                    addResult('dom-analysis', `${page}: ${isActive ? 'Active' : 'Inactive'}`);
                } else {
                    addResult('dom-analysis', `${page}: ❌ Manquant`);
                }
            });
            
            // 3. Vérifier les boutons de navigation
            const navButtons = document.querySelectorAll('.nav-btn');
            addResult('dom-analysis', `<h5>🔘 Boutons de Navigation: ${navButtons.length}</h5>`);
            
            navButtons.forEach((btn, index) => {
                const page = btn.dataset.page;
                const isActive = btn.classList.contains('active');
                addResult('dom-analysis', `Bouton ${index + 1}: ${page} (${isActive ? 'Active' : 'Inactive'})`);
            });
            
            log('✅ Analyse DOM terminée', 'success');
        }
        
        function analyzeJavaScript() {
            log('🔧 Analyse des scripts JavaScript...', 'info');
            
            addResult('js-analysis', '<h4>🔧 Scripts JavaScript:</h4>');
            
            // 1. Vérifier les scripts chargés
            const scripts = document.querySelectorAll('script[src]');
            addResult('js-analysis', `<h5>📜 Scripts Chargés: ${scripts.length}</h5>`);
            
            scripts.forEach((script, index) => {
                const src = script.src;
                const isLoaded = script.readyState === 'complete' || script.readyState === 'loaded';
                addResult('js-analysis', `Script ${index + 1}: ${src} (${isLoaded ? 'Chargé' : 'En cours'})`);
            });
            
            // 2. Vérifier les variables globales
            addResult('js-analysis', '<h5>🌐 Variables Globales:</h5>');
            const globalVars = [
                'isAuthenticated',
                'currentUser',
                'db',
                'isSupabaseConfigured',
                'projects',
                'sites'
            ];
            
            globalVars.forEach(varName => {
                const exists = typeof window[varName] !== 'undefined';
                const value = window[varName];
                addResult('js-analysis', `${varName}: ${exists ? (value || 'Défini') : 'Non défini'}`);
            });
            
            // 3. Vérifier les fonctions principales
            addResult('js-analysis', '<h5>🔧 Fonctions Principales:</h5>');
            const mainFunctions = [
                'initializeApp',
                'setupAuthEventListeners',
                'switchPage',
                'loadData',
                'renderProjects',
                'renderSites',
                'checkAuthentication',
                'showMainInterface',
                'showHomepage'
            ];
            
            mainFunctions.forEach(func => {
                const exists = typeof window[func] === 'function';
                addResult('js-analysis', `${func}: ${exists ? '✅' : '❌'}`);
            });
            
            log('✅ Analyse JavaScript terminée', 'success');
        }
        
        function analyzeAuthentication() {
            log('🔐 Analyse de l\'authentification...', 'info');
            
            addResult('auth-analysis', '<h4>🔐 Authentification:</h4>');
            
            // 1. Vérifier l'état d'authentification
            addResult('auth-analysis', '<h5>🔑 État d\'Authentification:</h5>');
            const isAuth = window.isAuthenticated;
            const currentUser = window.currentUser;
            const localStorageAuth = localStorage.getItem('isAuthenticated');
            const localStorageUser = localStorage.getItem('currentUser');
            
            addResult('auth-analysis', `isAuthenticated: ${isAuth || 'false'}`);
            addResult('auth-analysis', `currentUser: ${currentUser || 'null'}`);
            addResult('auth-analysis', `localStorage isAuthenticated: ${localStorageAuth || 'Non défini'}`);
            addResult('auth-analysis', `localStorage currentUser: ${localStorageUser ? 'Défini' : 'Non défini'}`);
            
            // 2. Vérifier la configuration Supabase
            addResult('auth-analysis', '<h5>🔧 Configuration Supabase:</h5>');
            const supabaseUrl = localStorage.getItem('supabase-url');
            const supabaseKey = localStorage.getItem('supabase-anon-key');
            const isSupabaseConfigured = window.isSupabaseConfigured;
            
            addResult('auth-analysis', `URL Supabase: ${supabaseUrl || 'Non configuré'}`);
            addResult('auth-analysis', `Clé Supabase: ${supabaseKey ? 'Configurée' : 'Non configurée'}`);
            addResult('auth-analysis', `isSupabaseConfigured: ${isSupabaseConfigured || 'false'}`);
            
            // 3. Vérifier les fonctions d'authentification
            addResult('auth-analysis', '<h5>🔧 Fonctions d\'Auth:</h5>');
            const authFunctions = [
                'checkAuthentication',
                'loginUser',
                'registerUser',
                'showLoginForm',
                'showRegisterForm',
                'showMainInterface',
                'showHomepage'
            ];
            
            authFunctions.forEach(func => {
                const exists = typeof window[func] === 'function';
                addResult('auth-analysis', `${func}: ${exists ? '✅' : '❌'}`);
            });
            
            log('✅ Analyse authentification terminée', 'success');
        }
        
        function analyzeData() {
            log('💾 Analyse des données...', 'info');
            
            addResult('data-analysis', '<h4>💾 Données:</h4>');
            
            // 1. Vérifier les données en mémoire
            addResult('data-analysis', '<h5>🧠 Données en Mémoire:</h5>');
            const projects = window.projects || [];
            const sites = window.sites || [];
            
            addResult('data-analysis', `Projets: ${projects.length}`);
            addResult('data-analysis', `Sites: ${sites.length}`);
            
            // 2. Vérifier localStorage
            addResult('data-analysis', '<h5>💾 localStorage:</h5>');
            const dataItems = [
                'ninjalinking-projects',
                'ninjalinking-sites',
                'isAuthenticated',
                'currentUser',
                'supabase-url',
                'supabase-anon-key'
            ];
            
            dataItems.forEach(item => {
                const value = localStorage.getItem(item);
                addResult('data-analysis', `${item}: ${value ? 'Défini' : 'Non défini'}`);
            });
            
            // 3. Vérifier les fonctions de données
            addResult('data-analysis', '<h5>🔧 Fonctions de Données:</h5>');
            const dataFunctions = [
                'loadData',
                'saveData',
                'renderProjects',
                'renderSites',
                'updateProjectStats'
            ];
            
            dataFunctions.forEach(func => {
                const exists = typeof window[func] === 'function';
                addResult('data-analysis', `${func}: ${exists ? '✅' : '❌'}`);
            });
            
            log('✅ Analyse données terminée', 'success');
        }
        
        function testCoreFunctionality() {
            log('🧪 Test des fonctionnalités de base...', 'info');
            
            addResult('functionality-results', '<h4>🧪 Tests de Fonctionnalités:</h4>');
            
            // 1. Test de l'initialisation
            addResult('functionality-results', '<h5>1. Test d\'Initialisation:</h5>');
            if (typeof initializeApp === 'function') {
                try {
                    initializeApp();
                    addResult('functionality-results', '✅ Initialisation réussie');
                } catch (error) {
                    addResult('functionality-results', `❌ Erreur initialisation: ${error.message}`);
                }
            } else {
                addResult('functionality-results', '❌ Fonction initializeApp non trouvée');
            }
            
            // 2. Test de la navigation
            addResult('functionality-results', '<h5>2. Test de Navigation:</h5>');
            if (typeof switchPage === 'function') {
                try {
                    switchPage('ninjalinking');
                    addResult('functionality-results', '✅ Navigation réussie');
                } catch (error) {
                    addResult('functionality-results', `❌ Erreur navigation: ${error.message}`);
                }
            } else {
                addResult('functionality-results', '❌ Fonction switchPage non trouvée');
            }
            
            // 3. Test du chargement des données
            addResult('functionality-results', '<h5>3. Test de Chargement:</h5>');
            if (typeof loadData === 'function') {
                try {
                    loadData();
                    addResult('functionality-results', '✅ Chargement des données réussi');
                } catch (error) {
                    addResult('functionality-results', `❌ Erreur chargement: ${error.message}`);
                }
            } else {
                addResult('functionality-results', '❌ Fonction loadData non trouvée');
            }
            
            log('✅ Tests de fonctionnalités terminés', 'success');
        }
        
        function testNavigation() {
            log('🧪 Test de navigation...', 'info');
            
            addResult('functionality-results', '<h4>🧪 Test de Navigation:</h4>');
            
            // Tester les boutons de navigation
            const navButtons = document.querySelectorAll('.nav-btn');
            addResult('functionality-results', `Boutons de navigation trouvés: ${navButtons.length}`);
            
            navButtons.forEach((btn, index) => {
                const page = btn.dataset.page;
                const hasClickListener = btn.onclick !== null;
                const hasEventListener = btn.addEventListener !== undefined;
                
                addResult('functionality-results', `Bouton ${index + 1} (${page}): onclick=${hasClickListener ? '✅' : '❌'}, addEventListener=${hasEventListener ? '✅' : '❌'}`);
            });
            
            // Tester la fonction switchPage
            if (typeof switchPage === 'function') {
                addResult('functionality-results', '✅ Fonction switchPage disponible');
            } else {
                addResult('functionality-results', '❌ Fonction switchPage non disponible');
            }
            
            log('✅ Test navigation terminé', 'success');
        }
        
        function testAuthentication() {
            log('🧪 Test d\'authentification...', 'info');
            
            addResult('functionality-results', '<h4>🧪 Test d\'Authentification:</h4>');
            
            // Vérifier l'état d'authentification
            const isAuth = window.isAuthenticated;
            const currentUser = window.currentUser;
            
            addResult('functionality-results', `État d'authentification: ${isAuth ? 'Connecté' : 'Non connecté'}`);
            addResult('functionality-results', `Utilisateur: ${currentUser ? 'Défini' : 'Non défini'}`);
            
            // Vérifier l'interface
            const homepage = document.getElementById('homepage-container');
            const authContainer = document.getElementById('auth-container');
            const mainInterface = document.getElementById('main-interface');
            
            addResult('functionality-results', `Page d'accueil: ${homepage ? (homepage.style.display !== 'none' ? 'Visible' : 'Cachée') : 'Non trouvée'}`);
            addResult('functionality-results', `Container auth: ${authContainer ? (authContainer.style.display !== 'none' ? 'Visible' : 'Cachée') : 'Non trouvé'}`);
            addResult('functionality-results', `Interface principale: ${mainInterface ? (mainInterface.style.display !== 'none' ? 'Visible' : 'Cachée') : 'Non trouvée'}`);
            
            log('✅ Test authentification terminé', 'success');
        }
        
        function generateCompleteReport() {
            log('📋 Génération du rapport complet...', 'info');
            
            addResult('report-results', '<h4>📋 Rapport Complet:</h4>');
            
            // Résumé des analyses
            addResult('report-results', '<h5>📊 Résumé des Analyses:</h5>');
            
            // Compter les problèmes
            const navButtons = document.querySelectorAll('.nav-btn');
            const criticalElements = ['homepage-container', 'auth-container', 'main-interface'];
            const missingElements = criticalElements.filter(id => !document.getElementById(id));
            const missingFunctions = ['initializeApp', 'switchPage', 'loadData'].filter(func => typeof window[func] !== 'function');
            
            addResult('report-results', `Boutons de navigation: ${navButtons.length}`);
            addResult('report-results', `Éléments critiques manquants: ${missingElements.length}`);
            addResult('report-results', `Fonctions manquantes: ${missingFunctions.length}`);
            
            // Recommandations
            addResult('report-results', '<h5>💡 Recommandations:</h5>');
            
            if (missingElements.length > 0) {
                addResult('report-results', '❌ Éléments DOM critiques manquants - Vérifier la structure HTML');
            }
            
            if (missingFunctions.length > 0) {
                addResult('report-results', '❌ Fonctions JavaScript manquantes - Vérifier le chargement des scripts');
            }
            
            if (navButtons.length === 0) {
                addResult('report-results', '❌ Aucun bouton de navigation trouvé - Vérifier la structure HTML');
            }
            
            if (missingElements.length === 0 && missingFunctions.length === 0 && navButtons.length > 0) {
                addResult('report-results', '✅ Structure de base correcte - Problème probablement dans la logique');
            }
            
            log('✅ Rapport complet généré', 'success');
        }
        
        function exportAnalysis() {
            log('📤 Export de l\'analyse...', 'info');
            
            const analysisData = {
                timestamp: new Date().toISOString(),
                domElements: {
                    homepage: !!document.getElementById('homepage-container'),
                    auth: !!document.getElementById('auth-container'),
                    main: !!document.getElementById('main-interface'),
                    navButtons: document.querySelectorAll('.nav-btn').length
                },
                functions: {
                    initializeApp: typeof window.initializeApp === 'function',
                    switchPage: typeof window.switchPage === 'function',
                    loadData: typeof window.loadData === 'function'
                },
                authentication: {
                    isAuthenticated: window.isAuthenticated,
                    currentUser: !!window.currentUser,
                    supabaseConfigured: window.isSupabaseConfigured
                }
            };
            
            const dataStr = JSON.stringify(analysisData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = 'analysis-report.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
            
            log('✅ Analyse exportée', 'success');
        }
        
        // Auto-analyse au chargement
        window.addEventListener('load', () => {
            setTimeout(() => {
                analyzeCriticalIssues();
                analyzeDOMStructure();
                analyzeJavaScript();
                analyzeAuthentication();
                analyzeData();
            }, 1000);
        });
    </script>
</body>
</html>
