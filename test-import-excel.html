<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Import Excel</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .test-section { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 5px; background: #f9f9f9; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
        .file-input { margin: 10px 0; }
        .preview-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .preview-table th, .preview-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .preview-table th { background: #f2f2f2; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Import Excel</h1>
        
        <div id="status" class="status info">
            Test d'import Excel pour les spots...
        </div>
        
        <div class="test-section">
            <h3>üìÅ Test de Lecture Excel</h3>
            <div class="file-input">
                <input type="file" id="testFile" accept=".xlsx,.xls" onchange="testExcelReading(event)">
                <label for="testFile">S√©lectionner un fichier Excel</label>
            </div>
            <div id="fileInfo"></div>
        </div>
        
        <div class="test-section">
            <h3>üìä Aper√ßu des Donn√©es</h3>
            <div id="dataPreview"></div>
        </div>
        
        <div class="test-section">
            <h3>üîç Test de Validation</h3>
            <div id="validationResults"></div>
        </div>
        
        <div class="test-section">
            <h3>üì• Test de G√©n√©ration Excel</h3>
            <button onclick="generateTestExcel()">G√©n√©rer fichier de test</button>
            <div id="generationResult"></div>
        </div>
        
        <div class="test-section">
            <h3>üîß Console de Debug</h3>
            <div id="debug-console" style="background: #f8f9fa; padding: 10px; border-radius: 3px; font-family: monospace; max-height: 200px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- SheetJS pour la lecture des fichiers Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        function log(message, type = 'info') {
            const console = document.getElementById('debug-console');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            console.textContent += logEntry;
            console.scrollTop = console.scrollHeight;
            
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function testExcelReading(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            log(`üìÅ Fichier s√©lectionn√©: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    log(`‚úÖ Fichier Excel lu avec succ√®s`);
                    log(`üìä Feuilles disponibles: ${workbook.SheetNames.join(', ')}`);
                    
                    // Prendre la premi√®re feuille
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convertir en JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    log(`üìã Nombre de lignes: ${jsonData.length}`);
                    
                    // Afficher les informations du fichier
                    document.getElementById('fileInfo').innerHTML = `
                        <p><strong>Nom:</strong> ${file.name}</p>
                        <p><strong>Taille:</strong> ${(file.size / 1024).toFixed(2)} KB</p>
                        <p><strong>Feuilles:</strong> ${workbook.SheetNames.join(', ')}</p>
                        <p><strong>Lignes:</strong> ${jsonData.length}</p>
                    `;
                    
                    // Afficher l'aper√ßu des donn√©es
                    displayDataPreview(jsonData);
                    
                    // Tester la validation
                    testDataValidation(jsonData);
                    
                } catch (error) {
                    log(`‚ùå Erreur lecture fichier: ${error.message}`, 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function displayDataPreview(jsonData) {
            if (jsonData.length === 0) {
                document.getElementById('dataPreview').innerHTML = '<p>Aucune donn√©e trouv√©e</p>';
                return;
            }
            
            const headers = jsonData[0];
            const dataRows = jsonData.slice(1, 6); // Afficher les 5 premi√®res lignes
            
            let html = '<h4>üìä Aper√ßu des donn√©es (5 premi√®res lignes)</h4>';
            html += '<table class="preview-table">';
            
            // En-t√™tes
            html += '<tr>';
            headers.forEach(header => {
                html += `<th>${header || 'Colonne vide'}</th>`;
            });
            html += '</tr>';
            
            // Donn√©es
            dataRows.forEach(row => {
                html += '<tr>';
                headers.forEach((header, index) => {
                    const value = row[index] || '';
                    html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</table>';
            
            document.getElementById('dataPreview').innerHTML = html;
        }
        
        function testDataValidation(jsonData) {
            if (jsonData.length < 2) {
                document.getElementById('validationResults').innerHTML = '<p>‚ùå Pas assez de donn√©es pour valider</p>';
                return;
            }
            
            const headers = jsonData[0];
            const dataRows = jsonData.slice(1);
            
            // V√©rifier les en-t√™tes requis
            const requiredHeaders = ['URL', 'Type', 'Th√©matique', 'Trust Flow', 'Trafic', 'TTF', 'Prix', 'Statut'];
            const missingHeaders = requiredHeaders.filter(header => !headers.includes(header));
            
            let html = '<h4>üîç R√©sultats de validation</h4>';
            
            if (missingHeaders.length > 0) {
                html += `<p class="error">‚ùå Colonnes manquantes: ${missingHeaders.join(', ')}</p>`;
            } else {
                html += '<p class="success">‚úÖ Toutes les colonnes requises sont pr√©sentes</p>';
            }
            
            // Valider les donn√©es
            let validRows = 0;
            let invalidRows = 0;
            const errors = [];
            
            dataRows.forEach((row, index) => {
                if (row.length === 0 || row.every(cell => !cell)) return;
                
                const url = row[headers.indexOf('URL')]?.toString().trim() || '';
                const trustFlow = parseInt(row[headers.indexOf('Trust Flow')]) || 0;
                const traffic = parseInt(row[headers.indexOf('Trafic')]) || 0;
                const price = parseFloat(row[headers.indexOf('Prix')]) || 0;
                
                let rowValid = true;
                
                if (!url) {
                    errors.push(`Ligne ${index + 2}: URL manquante`);
                    rowValid = false;
                } else if (!isValidUrl(url)) {
                    errors.push(`Ligne ${index + 2}: URL invalide (${url})`);
                    rowValid = false;
                }
                
                if (trustFlow < 0 || trustFlow > 100) {
                    errors.push(`Ligne ${index + 2}: Trust Flow invalide (${trustFlow})`);
                    rowValid = false;
                }
                
                if (traffic < 0) {
                    errors.push(`Ligne ${index + 2}: Trafic invalide (${traffic})`);
                    rowValid = false;
                }
                
                if (price < 0) {
                    errors.push(`Ligne ${index + 2}: Prix invalide (${price})`);
                    rowValid = false;
                }
                
                if (rowValid) {
                    validRows++;
                } else {
                    invalidRows++;
                }
            });
            
            html += `<p><strong>Lignes valides:</strong> ${validRows}</p>`;
            html += `<p><strong>Lignes invalides:</strong> ${invalidRows}</p>`;
            
            if (errors.length > 0) {
                html += '<h5>‚ùå Erreurs d√©tect√©es:</h5>';
                html += '<div style="max-height: 150px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">';
                errors.slice(0, 10).forEach(error => {
                    html += `<p style="margin: 5px 0; color: #dc3545;">‚Ä¢ ${error}</p>`;
                });
                if (errors.length > 10) {
                    html += `<p>... et ${errors.length - 10} autres erreurs</p>`;
                }
                html += '</div>';
            }
            
            document.getElementById('validationResults').innerHTML = html;
        }
        
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }
        
        function generateTestExcel() {
            try {
                log('üìä G√©n√©ration du fichier Excel de test...');
                
                // Cr√©er les donn√©es de test
                const testData = [
                    ['URL', 'Type', 'Th√©matique', 'Trust Flow', 'Trafic', 'TTF', 'Prix', 'Statut'],
                    ['https://test-blog.com', 'Blog', 'Business & Marketing', 45, 15000, 'Business', 75.00, 'A publier'],
                    ['https://test-forum.com', 'Forum', 'Technologie & Informatique', 30, 8000, 'Computers', 50.00, 'En attente'],
                    ['https://test-media.com', 'M√©dia', 'Actualit√©s & M√©dias', 70, 25000, 'News', 150.00, 'Publi√©'],
                    ['https://test-ecommerce.com', 'E-commerce', 'E-commerce & Affiliation', 25, 5000, 'Shopping', 100.00, 'A publier'],
                    ['https://test-vitrine.com', 'Vitrine', 'Lifestyle & Loisirs', 15, 3000, 'Lifestyle', 25.00, 'A publier']
                ];
                
                // Cr√©er un workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(testData);
                
                // Ajouter la feuille au workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Spots');
                
                // G√©n√©rer le fichier Excel
                const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                
                // Cr√©er un blob et t√©l√©charger
                const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = window.URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = 'test-spots-import.xlsx';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                window.URL.revokeObjectURL(url);
                
                log('‚úÖ Fichier Excel de test g√©n√©r√© et t√©l√©charg√©', 'success');
                document.getElementById('generationResult').innerHTML = '<p class="success">‚úÖ Fichier Excel de test g√©n√©r√© avec succ√®s!</p>';
                
            } catch (error) {
                log(`‚ùå Erreur g√©n√©ration Excel: ${error.message}`, 'error');
                document.getElementById('generationResult').innerHTML = `<p class="error">‚ùå Erreur: ${error.message}</p>`;
            }
        }
        
        // Initialiser
        log('üß™ Test d\'import Excel initialis√©');
    </script>
</body>
</html>
