<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V√©rification Supabase Production</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .test-section { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 5px; background: #f9f9f9; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
        .credentials { background: #e7f3ff; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .test-pass { background: #d4edda; color: #155724; }
        .test-fail { background: #f8d7da; color: #721c24; }
        .test-warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ V√©rification Supabase Production</h1>
        
        <div id="status" class="status info">
            Initialisation des tests de production...
        </div>
        
        <div class="credentials">
            <h3>üîë Credentials Supabase</h3>
            <p><strong>URL :</strong> <span id="currentUrl">V√©rification...</span></p>
            <p><strong>Cl√© :</strong> <span id="currentKey">V√©rification...</span></p>
            <p><strong>Statut :</strong> <span id="configStatus">V√©rification...</span></p>
        </div>
        
        <div class="test-section">
            <h3>üîß Tests de Configuration</h3>
            <button onclick="testBasicConnection()">1Ô∏è‚É£ Test Connexion Basique</button>
            <button onclick="testAuthentication()">2Ô∏è‚É£ Test Authentification</button>
            <button onclick="testTables()">3Ô∏è‚É£ Test Tables</button>
            <button onclick="testRLS()">4Ô∏è‚É£ Test RLS</button>
            <button onclick="testBudgetColumn()">5Ô∏è‚É£ Test Colonne Budget</button>
            <button onclick="runAllTests()">üöÄ Lancer Tous les Tests</button>
        </div>
        
        <div class="test-section">
            <h3>üìä Tests de Donn√©es</h3>
            <button onclick="testCreateProject()">‚ûï Cr√©er Projet Test</button>
            <button onclick="testCreateSpot()">üìç Cr√©er Spot Test</button>
            <button onclick="testBudgetFeature()">üí∞ Test Fonctionnalit√© Budget</button>
            <button onclick="testImportExcel()">üìä Test Import Excel</button>
        </div>
        
        <div class="test-section">
            <h3>üîç Diagnostic Avanc√©</h3>
            <button onclick="checkDatabaseSchema()">üèóÔ∏è V√©rifier Sch√©ma DB</button>
            <button onclick="checkPermissions()">üîê V√©rifier Permissions</button>
            <button onclick="checkPerformance()">‚ö° Test Performance</button>
            <button onclick="exportDiagnostics()">üì§ Exporter Diagnostics</button>
        </div>
        
        <div class="test-section">
            <h3>üìã R√©sultats des Tests</h3>
            <div id="test-results">En attente des tests...</div>
        </div>
        
        <div class="test-section">
            <h3>üîß Console de Debug</h3>
            <div id="debug-console" style="background: #f8f9fa; padding: 10px; border-radius: 3px; font-family: monospace; max-height: 300px; overflow-y: auto;"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-service.js"></script>
    
    <script>
        let supabase = null;
        let testResults = [];
        
        function log(message, type = 'info') {
            const console = document.getElementById('debug-console');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            console.textContent += logEntry;
            console.scrollTop = console.scrollHeight;
            
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        function addTestResult(testName, passed, message, details = '') {
            testResults.push({ testName, passed, message, details });
            updateTestResults();
        }
        
        function updateTestResults() {
            const resultsDiv = document.getElementById('test-results');
            let html = '<h4>üìä R√©sultats des Tests</h4>';
            
            testResults.forEach(result => {
                const statusClass = result.passed ? 'test-pass' : 'test-fail';
                html += `
                    <div class="test-result ${statusClass}">
                        <strong>${result.testName}:</strong> ${result.message}
                        ${result.details ? `<br><small>${result.details}</small>` : ''}
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        async function init() {
            log('üîç Initialisation des tests de production...');
            
            // V√©rifier la configuration actuelle
            const url = localStorage.getItem('supabase-url');
            const key = localStorage.getItem('supabase-anon-key');
            
            document.getElementById('currentUrl').textContent = url || 'Non configur√©';
            document.getElementById('currentKey').textContent = key ? key.substring(0, 20) + '...' : 'Non configur√©';
            document.getElementById('configStatus').textContent = (url && key) ? '‚úÖ Configur√©' : '‚ùå Non configur√©';
            
            if (url && key) {
                try {
                    supabase = createClient(url, key);
                    log('‚úÖ Client Supabase initialis√©');
                } catch (error) {
                    log(`‚ùå Erreur initialisation Supabase: ${error.message}`, 'error');
                }
            } else {
                log('‚ö†Ô∏è Supabase non configur√©', 'warning');
            }
        }
        
        async function testBasicConnection() {
            log('üß™ Test de connexion basique...');
            
            try {
                if (!supabase) {
                    throw new Error('Client Supabase non initialis√©');
                }
                
                const { data, error } = await supabase
                    .from('projects')
                    .select('id')
                    .limit(1);
                
                if (error) throw error;
                
                addTestResult('Connexion Basique', true, 'Connexion r√©ussie', `Donn√©es re√ßues: ${JSON.stringify(data)}`);
                log('‚úÖ Test de connexion basique r√©ussi');
                
            } catch (error) {
                addTestResult('Connexion Basique', false, '√âchec de la connexion', error.message);
                log(`‚ùå Test de connexion basique √©chou√©: ${error.message}`, 'error');
            }
        }
        
        async function testAuthentication() {
            log('üîê Test d\'authentification...');
            
            try {
                if (!supabase) {
                    throw new Error('Client Supabase non initialis√©');
                }
                
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error) throw error;
                
                if (user) {
                    addTestResult('Authentification', true, 'Utilisateur connect√©', `Email: ${user.email}`);
                    log('‚úÖ Utilisateur authentifi√©');
                } else {
                    addTestResult('Authentification', false, 'Aucun utilisateur connect√©', 'Connexion requise');
                    log('‚ö†Ô∏è Aucun utilisateur connect√©', 'warning');
                }
                
            } catch (error) {
                addTestResult('Authentification', false, 'Erreur d\'authentification', error.message);
                log(`‚ùå Test d'authentification √©chou√©: ${error.message}`, 'error');
            }
        }
        
        async function testTables() {
            log('üìä Test des tables...');
            
            try {
                if (!supabase) {
                    throw new Error('Client Supabase non initialis√©');
                }
                
                // Test table projects
                const { data: projects, error: projectsError } = await supabase
                    .from('projects')
                    .select('id, name, budget')
                    .limit(1);
                
                if (projectsError) throw new Error(`Erreur table projects: ${projectsError.message}`);
                
                // Test table sites
                const { data: sites, error: sitesError } = await supabase
                    .from('sites')
                    .select('id, url, type')
                    .limit(1);
                
                if (sitesError) throw new Error(`Erreur table sites: ${sitesError.message}`);
                
                addTestResult('Tables', true, 'Tables accessibles', `Projects: ${projects?.length || 0}, Sites: ${sites?.length || 0}`);
                log('‚úÖ Tables accessibles');
                
            } catch (error) {
                addTestResult('Tables', false, 'Erreur d\'acc√®s aux tables', error.message);
                log(`‚ùå Test des tables √©chou√©: ${error.message}`, 'error');
            }
        }
        
        async function testRLS() {
            log('üîê Test RLS (Row Level Security)...');
            
            try {
                if (!supabase) {
                    throw new Error('Client Supabase non initialis√©');
                }
                
                // Test avec un utilisateur non authentifi√©
                const { data, error } = await supabase
                    .from('projects')
                    .select('*');
                
                if (error && error.code === 'PGRST301') {
                    addTestResult('RLS', true, 'RLS activ√© (acc√®s restreint)', 'S√©curit√© correcte');
                    log('‚úÖ RLS activ√© - acc√®s restreint');
                } else if (data) {
                    addTestResult('RLS', false, 'RLS non activ√©', 'Donn√©es accessibles sans authentification');
                    log('‚ö†Ô∏è RLS non activ√© - donn√©es publiques', 'warning');
                } else {
                    addTestResult('RLS', false, 'Erreur RLS', error.message);
                    log(`‚ùå Erreur RLS: ${error.message}`, 'error');
                }
                
            } catch (error) {
                addTestResult('RLS', false, 'Erreur test RLS', error.message);
                log(`‚ùå Test RLS √©chou√©: ${error.message}`, 'error');
            }
        }
        
        async function testBudgetColumn() {
            log('üí∞ Test colonne budget...');
            
            try {
                if (!supabase) {
                    throw new Error('Client Supabase non initialis√©');
                }
                
                const { data, error } = await supabase
                    .from('projects')
                    .select('budget')
                    .limit(1);
                
                if (error) throw error;
                
                addTestResult('Colonne Budget', true, 'Colonne budget accessible', 'Fonctionnalit√© budget op√©rationnelle');
                log('‚úÖ Colonne budget accessible');
                
            } catch (error) {
                addTestResult('Colonne Budget', false, 'Colonne budget manquante', error.message);
                log(`‚ùå Test colonne budget √©chou√©: ${error.message}`, 'error');
            }
        }
        
        async function testCreateProject() {
            log('‚ûï Test cr√©ation projet...');
            
            try {
                if (!supabase) {
                    throw new Error('Client Supabase non initialis√©');
                }
                
                const testProject = {
                    name: 'Test Production ' + Date.now(),
                    url: 'https://test-production.com',
                    objective: 'SEO',
                    budget: 1000.00,
                    keywords: ['test', 'production'],
                    spots: []
                };
                
                const { data, error } = await supabase
                    .from('projects')
                    .insert([testProject])
                    .select()
                    .single();
                
                if (error) throw error;
                
                addTestResult('Cr√©ation Projet', true, 'Projet cr√©√© avec succ√®s', `ID: ${data.id}`);
                log('‚úÖ Projet test cr√©√©');
                
                // Nettoyer le projet test
                await supabase.from('projects').delete().eq('id', data.id);
                log('üßπ Projet test supprim√©');
                
            } catch (error) {
                addTestResult('Cr√©ation Projet', false, '√âchec cr√©ation projet', error.message);
                log(`‚ùå Test cr√©ation projet √©chou√©: ${error.message}`, 'error');
            }
        }
        
        async function testCreateSpot() {
            log('üìç Test cr√©ation spot...');
            
            try {
                if (!supabase) {
                    throw new Error('Client Supabase non initialis√©');
                }
                
                // Cr√©er un projet temporaire
                const { data: project, error: projectError } = await supabase
                    .from('projects')
                    .insert([{
                        name: 'Test Spots ' + Date.now(),
                        url: 'https://test-spots.com',
                        objective: 'SEO',
                        budget: 500.00,
                        keywords: [],
                        spots: []
                    }])
                    .select()
                    .single();
                
                if (projectError) throw projectError;
                
                // Ajouter un spot
                const testSpot = {
                    id: Date.now(),
                    url: 'https://test-spot.com',
                    type: 'Blog',
                    theme: 'Business',
                    trustFlow: 50,
                    traffic: 10000,
                    price: 75.00,
                    status: 'A publier'
                };
                
                const updatedSpots = [...(project.spots || []), testSpot];
                
                const { data: updatedProject, error: updateError } = await supabase
                    .from('projects')
                    .update({ spots: updatedSpots })
                    .eq('id', project.id)
                    .select()
                    .single();
                
                if (updateError) throw updateError;
                
                addTestResult('Cr√©ation Spot', true, 'Spot cr√©√© avec succ√®s', `Projet: ${updatedProject.name}`);
                log('‚úÖ Spot test cr√©√©');
                
                // Nettoyer
                await supabase.from('projects').delete().eq('id', project.id);
                log('üßπ Projet test supprim√©');
                
            } catch (error) {
                addTestResult('Cr√©ation Spot', false, '√âchec cr√©ation spot', error.message);
                log(`‚ùå Test cr√©ation spot √©chou√©: ${error.message}`, 'error');
            }
        }
        
        async function testBudgetFeature() {
            log('üí∞ Test fonctionnalit√© budget...');
            
            try {
                if (!supabase) {
                    throw new Error('Client Supabase non initialis√©');
                }
                
                // Cr√©er un projet avec budget et spots
                const testProject = {
                    name: 'Test Budget ' + Date.now(),
                    url: 'https://test-budget.com',
                    objective: 'SEO',
                    budget: 2000.00,
                    keywords: ['test'],
                    spots: [
                        {
                            id: 1,
                            url: 'https://spot1.com',
                            type: 'Blog',
                            price: 100.00,
                            status: 'Publi√©'
                        },
                        {
                            id: 2,
                            url: 'https://spot2.com',
                            type: 'Forum',
                            price: 150.00,
                            status: 'A publier'
                        }
                    ]
                };
                
                const { data: project, error: projectError } = await supabase
                    .from('projects')
                    .insert([testProject])
                    .select()
                    .single();
                
                if (projectError) throw projectError;
                
                // Calculer le budget
                const totalSpent = project.spots
                    .filter(spot => spot.status === 'Publi√©')
                    .reduce((sum, spot) => sum + (spot.price || 0), 0);
                
                const pendingBudget = project.spots
                    .filter(spot => spot.status === 'A publier')
                    .reduce((sum, spot) => sum + (spot.price || 0), 0);
                
                const remaining = project.budget - totalSpent - pendingBudget;
                
                addTestResult('Fonctionnalit√© Budget', true, 'Calcul budget correct', 
                    `Budget: ${project.budget}‚Ç¨, D√©pens√©: ${totalSpent}‚Ç¨, En attente: ${pendingBudget}‚Ç¨, Reste: ${remaining}‚Ç¨`);
                log('‚úÖ Fonctionnalit√© budget op√©rationnelle');
                
                // Nettoyer
                await supabase.from('projects').delete().eq('id', project.id);
                log('üßπ Projet test supprim√©');
                
            } catch (error) {
                addTestResult('Fonctionnalit√© Budget', false, '√âchec test budget', error.message);
                log(`‚ùå Test fonctionnalit√© budget √©chou√©: ${error.message}`, 'error');
            }
        }
        
        async function testImportExcel() {
            log('üìä Test import Excel...');
            
            try {
                // Simuler des donn√©es Excel
                const excelData = [
                    ['URL', 'Type', 'Th√©matique', 'Trust Flow', 'Trafic', 'TTF', 'Prix', 'Statut'],
                    ['https://test-excel1.com', 'Blog', 'Business', 45, 15000, 'Business', 75.00, 'A publier'],
                    ['https://test-excel2.com', 'Forum', 'Tech', 30, 8000, 'Computers', 50.00, 'En attente']
                ];
                
                // Valider le format
                const headers = excelData[0];
                const requiredHeaders = ['URL', 'Type', 'Th√©matique', 'Trust Flow', 'Trafic', 'TTF', 'Prix', 'Statut'];
                const missingHeaders = requiredHeaders.filter(header => !headers.includes(header));
                
                if (missingHeaders.length > 0) {
                    throw new Error(`Colonnes manquantes: ${missingHeaders.join(', ')}`);
                }
                
                // Traiter les donn√©es
                const processedSpots = excelData.slice(1).map((row, index) => ({
                    id: Date.now() + index,
                    url: row[0],
                    type: row[1],
                    theme: row[2],
                    trustFlow: parseInt(row[3]) || 0,
                    traffic: parseInt(row[4]) || 0,
                    ttf: row[5],
                    price: parseFloat(row[6]) || 0,
                    status: row[7]
                }));
                
                addTestResult('Import Excel', true, 'Format Excel valide', 
                    `${processedSpots.length} spots trait√©s, Prix total: ${processedSpots.reduce((sum, spot) => sum + spot.price, 0)}‚Ç¨`);
                log('‚úÖ Import Excel fonctionnel');
                
            } catch (error) {
                addTestResult('Import Excel', false, '√âchec test import Excel', error.message);
                log(`‚ùå Test import Excel √©chou√©: ${error.message}`, 'error');
            }
        }
        
        async function checkDatabaseSchema() {
            log('üèóÔ∏è V√©rification sch√©ma base de donn√©es...');
            
            try {
                if (!supabase) {
                    throw new Error('Client Supabase non initialis√©');
                }
                
                // V√©rifier la structure de la table projects
                const { data: projectsColumns, error: projectsError } = await supabase
                    .rpc('get_table_columns', { table_name: 'projects' });
                
                if (projectsError) {
                    // Fallback: test direct
                    const { data, error } = await supabase
                        .from('projects')
                        .select('*')
                        .limit(0);
                    
                    if (error) throw error;
                    
                    addTestResult('Sch√©ma DB', true, 'Structure tables accessible', 'Tables projects et sites op√©rationnelles');
                } else {
                    addTestResult('Sch√©ma DB', true, 'Sch√©ma v√©rifi√©', `Colonnes: ${projectsColumns?.length || 'N/A'}`);
                }
                
                log('‚úÖ Sch√©ma base de donn√©es v√©rifi√©');
                
            } catch (error) {
                addTestResult('Sch√©ma DB', false, 'Erreur v√©rification sch√©ma', error.message);
                log(`‚ùå V√©rification sch√©ma √©chou√©e: ${error.message}`, 'error');
            }
        }
        
        async function checkPermissions() {
            log('üîê V√©rification permissions...');
            
            try {
                if (!supabase) {
                    throw new Error('Client Supabase non initialis√©');
                }
                
                // Test lecture
                const { data: readData, error: readError } = await supabase
                    .from('projects')
                    .select('id')
                    .limit(1);
                
                // Test √©criture (si authentifi√©)
                const { data: { user } } = await supabase.auth.getUser();
                
                if (user) {
                    const { data: writeData, error: writeError } = await supabase
                        .from('projects')
                        .insert([{
                            name: 'Test Permissions',
                            url: 'https://test-permissions.com',
                            objective: 'SEO',
                            budget: 0
                        }])
                        .select()
                        .single();
                    
                    if (writeError) throw writeError;
                    
                    // Nettoyer
                    await supabase.from('projects').delete().eq('id', writeData.id);
                }
                
                addTestResult('Permissions', true, 'Permissions correctes', 
                    `Lecture: ${readError ? 'Erreur' : 'OK'}, √âcriture: ${user ? 'OK' : 'Non test√© (non authentifi√©)'}`);
                log('‚úÖ Permissions v√©rifi√©es');
                
            } catch (error) {
                addTestResult('Permissions', false, 'Erreur permissions', error.message);
                log(`‚ùå V√©rification permissions √©chou√©e: ${error.message}`, 'error');
            }
        }
        
        async function checkPerformance() {
            log('‚ö° Test performance...');
            
            try {
                if (!supabase) {
                    throw new Error('Client Supabase non initialis√©');
                }
                
                const startTime = Date.now();
                
                // Test de performance
                const { data, error } = await supabase
                    .from('projects')
                    .select('id, name, budget')
                    .limit(10);
                
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                if (error) throw error;
                
                const performance = duration < 1000 ? 'Excellent' : duration < 3000 ? 'Bon' : 'Lent';
                
                addTestResult('Performance', true, `Performance ${performance}`, 
                    `Temps de r√©ponse: ${duration}ms, Donn√©es: ${data?.length || 0} projets`);
                log(`‚úÖ Performance test√©e: ${duration}ms`);
                
            } catch (error) {
                addTestResult('Performance', false, 'Erreur test performance', error.message);
                log(`‚ùå Test performance √©chou√©: ${error.message}`, 'error');
            }
        }
        
        async function exportDiagnostics() {
            log('üì§ Export des diagnostics...');
            
            const diagnostics = {
                timestamp: new Date().toISOString(),
                url: localStorage.getItem('supabase-url'),
                key: localStorage.getItem('supabase-anon-key')?.substring(0, 20) + '...',
                testResults: testResults,
                userAgent: navigator.userAgent,
                localStorage: {
                    'supabase-configured': localStorage.getItem('supabase-configured'),
                    'isAuthenticated': localStorage.getItem('isAuthenticated'),
                    'currentUser': localStorage.getItem('currentUser')
                }
            };
            
            const blob = new Blob([JSON.stringify(diagnostics, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `supabase-diagnostics-${Date.now()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
            
            log('‚úÖ Diagnostics export√©s');
        }
        
        async function runAllTests() {
            log('üöÄ Lancement de tous les tests...');
            
            testResults = [];
            
            await testBasicConnection();
            await testAuthentication();
            await testTables();
            await testRLS();
            await testBudgetColumn();
            await testCreateProject();
            await testCreateSpot();
            await testBudgetFeature();
            await testImportExcel();
            await checkDatabaseSchema();
            await checkPermissions();
            await checkPerformance();
            
            const passedTests = testResults.filter(r => r.passed).length;
            const totalTests = testResults.length;
            
            log(`‚úÖ Tests termin√©s: ${passedTests}/${totalTests} r√©ussis`);
            
            if (passedTests === totalTests) {
                log('üéâ Tous les tests sont pass√©s ! Pr√™t pour la production.', 'success');
            } else {
                log(`‚ö†Ô∏è ${totalTests - passedTests} test(s) ont √©chou√©. V√©rifiez avant la production.`, 'warning');
            }
        }
        
        // Initialiser
        init();
    </script>
</body>
</html>
