<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sauvegarde Budget</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .test-section { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 5px; background: #f9f9f9; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Sauvegarde Budget</h1>
        
        <div id="status" class="status info">
            Initialisation du test...
        </div>
        
        <div class="test-section">
            <h3>üìä √âtat Actuel</h3>
            <div id="current-state">Analyse en cours...</div>
        </div>
        
        <div class="test-section">
            <h3>üß™ Tests de Sauvegarde</h3>
            <button onclick="testBudgetSave()">üíæ Tester Sauvegarde Budget</button>
            <button onclick="createTestProject()">‚ûï Cr√©er Projet Test</button>
            <button onclick="verifyBudgetData()">üîç V√©rifier Donn√©es Budget</button>
            <button onclick="testBudgetCalculation()">üßÆ Tester Calcul Budget</button>
        </div>
        
        <div class="test-section">
            <h3>üìã R√©sultats des Tests</h3>
            <div id="test-results">En attente...</div>
        </div>
        
        <div class="test-section">
            <h3>üîß Console de Debug</h3>
            <div id="debug-console" style="background: #f8f9fa; padding: 10px; border-radius: 3px; font-family: monospace; max-height: 200px; overflow-y: auto;"></div>
        </div>
    </div>

    <script src="supabase-service.js"></script>
    <script>
        let projects = [];
        let isAuthenticated = false;
        let isSupabaseConfigured = false;
        let db = null;

        function log(message, type = 'info') {
            const console = document.getElementById('debug-console');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            console.textContent += logEntry;
            console.scrollTop = console.scrollHeight;
            
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        async function init() {
            log('üîç Initialisation du test de sauvegarde budget...');
            
            try {
                // V√©rifier l'authentification
                isAuthenticated = localStorage.getItem('ninjalinking-authenticated') === 'true';
                log(`Authentification: ${isAuthenticated ? '‚úÖ Connect√©' : '‚ùå Non connect√©'}`);
                
                // V√©rifier Supabase
                isSupabaseConfigured = localStorage.getItem('ninjalinking-supabase-configured') === 'true';
                log(`Supabase: ${isSupabaseConfigured ? '‚úÖ Configur√©' : '‚ùå Non configur√©'}`);
                
                if (isSupabaseConfigured) {
                    db = new SupabaseService();
                    await db.initialize();
                    log('‚úÖ Service Supabase initialis√©');
                }
                
                // Charger les projets
                await loadProjects();
                
            } catch (error) {
                log(`‚ùå Erreur d'initialisation: ${error.message}`, 'error');
            }
        }
        
        async function loadProjects() {
            try {
                if (isSupabaseConfigured && db && isAuthenticated) {
                    projects = await db.getProjects();
                    log(`üìä Projets charg√©s depuis Supabase: ${projects.length}`);
                } else {
                    const savedProjects = localStorage.getItem('ninjalinking-projects');
                    if (savedProjects) {
                        projects = JSON.parse(savedProjects);
                        log(`üìä Projets charg√©s depuis localStorage: ${projects.length}`);
                    } else {
                        projects = [];
                        log('‚ö†Ô∏è Aucun projet trouv√©', 'warning');
                    }
                }
                
                displayCurrentState();
                
            } catch (error) {
                log(`‚ùå Erreur chargement projets: ${error.message}`, 'error');
            }
        }
        
        function displayCurrentState() {
            const state = document.getElementById('current-state');
            
            let html = `<p><strong>Nombre de projets:</strong> ${projects.length}</p>`;
            
            if (projects.length > 0) {
                html += '<div style="margin-top: 10px;">';
                projects.forEach((project, index) => {
                    html += `
                        <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <strong>${project.name}</strong> (ID: ${project.id})<br>
                            <small>Budget: ${project.budget || 0}‚Ç¨ | Spots: ${project.spots ? project.spots.length : 0}</small>
                            ${project.budget ? '<span style="color: green;"> ‚úÖ Budget d√©fini</span>' : '<span style="color: red;"> ‚ùå Pas de budget</span>'}
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            state.innerHTML = html;
        }
        
        async function testBudgetSave() {
            log('üß™ Test de sauvegarde du budget...');
            
            try {
                const testProject = {
                    name: 'Test Budget ' + Date.now(),
                    url: 'https://test-budget.com',
                    objective: 'SEO',
                    traffic: 1000,
                    trustFlow: 50,
                    ttf: 'Business',
                    referringDomains: 10,
                    publicationGoal: 5,
                    budget: 1000.50, // Budget de test
                    keywords: ['test', 'budget'],
                    spots: [
                        {
                            id: 1,
                            url: 'https://test-spot1.com',
                            type: 'Blog',
                            theme: 'G√©n√©raliste',
                            trustFlow: 30,
                            traffic: 500,
                            price: 25.00,
                            status: 'A publier'
                        },
                        {
                            id: 2,
                            url: 'https://test-spot2.com',
                            type: 'Forum',
                            theme: 'Business',
                            trustFlow: 40,
                            traffic: 800,
                            price: 50.00,
                            status: 'Publi√©'
                        }
                    ],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                if (isSupabaseConfigured && db && isAuthenticated) {
                    const savedProject = await db.saveProject(testProject);
                    log(`‚úÖ Projet test sauvegard√© dans Supabase avec budget: ${savedProject.budget}‚Ç¨`);
                } else {
                    testProject.id = Date.now();
                    projects.push(testProject);
                    localStorage.setItem('ninjalinking-projects', JSON.stringify(projects));
                    log(`‚úÖ Projet test sauvegard√© dans localStorage avec budget: ${testProject.budget}‚Ç¨`);
                }
                
                await loadProjects();
                log('‚úÖ Test de sauvegarde r√©ussi', 'success');
                
            } catch (error) {
                log(`‚ùå Erreur test sauvegarde: ${error.message}`, 'error');
            }
        }
        
        function createTestProject() {
            log('‚ûï Cr√©ation d\'un projet test avec budget...');
            
            const testProject = {
                id: Date.now(),
                name: 'Projet Test Budget',
                url: 'https://test-budget-example.com',
                objective: 'SEO',
                traffic: 2000,
                trustFlow: 60,
                ttf: 'Business',
                referringDomains: 20,
                budget: 2000.00,
                keywords: ['test', 'budget', 'exemple'],
                spots: [
                    {
                        id: 1,
                        url: 'https://example-spot1.com',
                        type: 'Blog',
                        theme: 'G√©n√©raliste',
                        trustFlow: 35,
                        traffic: 1000,
                        price: 75.00,
                        status: 'A publier'
                    },
                    {
                        id: 2,
                        url: 'https://example-spot2.com',
                        type: 'Forum',
                        theme: 'Business',
                        trustFlow: 45,
                        traffic: 1500,
                        price: 100.00,
                        status: 'En attente'
                    },
                    {
                        id: 3,
                        url: 'https://example-spot3.com',
                        type: 'M√©dia',
                        theme: 'Actualit√©s',
                        trustFlow: 70,
                        traffic: 3000,
                        price: 200.00,
                        status: 'Publi√©'
                    }
                ],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            projects.push(testProject);
            localStorage.setItem('ninjalinking-projects', JSON.stringify(projects));
            
            log('‚úÖ Projet test cr√©√© avec budget et spots', 'success');
            displayCurrentState();
        }
        
        function verifyBudgetData() {
            log('üîç V√©rification des donn√©es de budget...');
            
            let results = [];
            
            projects.forEach((project, index) => {
                const hasBudget = project.budget !== undefined && project.budget !== null;
                const budgetValue = project.budget || 0;
                const spotsCount = project.spots ? project.spots.length : 0;
                
                results.push({
                    name: project.name,
                    hasBudget: hasBudget,
                    budgetValue: budgetValue,
                    spotsCount: spotsCount,
                    spots: project.spots || []
                });
                
                log(`Projet ${index + 1}: ${project.name} - Budget: ${budgetValue}‚Ç¨ - Spots: ${spotsCount}`);
            });
            
            const resultsHtml = results.map(result => `
                <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <strong>${result.name}</strong><br>
                    <small>Budget: ${result.budgetValue}‚Ç¨ | Spots: ${result.spotsCount}</small><br>
                    ${result.hasBudget ? '<span style="color: green;">‚úÖ Budget OK</span>' : '<span style="color: red;">‚ùå Pas de budget</span>'}
                    ${result.spots.map(spot => `<br>- ${spot.url}: ${spot.price}‚Ç¨ (${spot.status})`).join('')}
                </div>
            `).join('');
            
            document.getElementById('test-results').innerHTML = resultsHtml;
            log('‚úÖ V√©rification termin√©e', 'success');
        }
        
        function testBudgetCalculation() {
            log('üßÆ Test de calcul du budget...');
            
            if (projects.length === 0) {
                log('‚ö†Ô∏è Aucun projet pour tester', 'warning');
                return;
            }
            
            const project = projects[0];
            const budget = project.budget || 0;
            const spots = project.spots || [];
            
            // Calculer les d√©penses (spots "Publi√©")
            const totalExpenses = spots
                .filter(spot => spot.status === 'Publi√©')
                .reduce((sum, spot) => sum + (spot.price || 0), 0);
            
            // Calculer le budget en attente (spots "A publier" et "En attente")
            const pendingBudget = spots
                .filter(spot => spot.status === 'A publier' || spot.status === 'En attente')
                .reduce((sum, spot) => sum + (spot.price || 0), 0);
            
            const totalEngaged = totalExpenses + pendingBudget;
            const remainingBudget = budget - totalEngaged;
            
            const calculationHtml = `
                <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: #f0f8ff;">
                    <strong>Calcul du budget pour "${project.name}":</strong><br>
                    <small>
                        Budget allou√©: ${budget.toFixed(2)}‚Ç¨<br>
                        D√©penses (Publi√©): ${totalExpenses.toFixed(2)}‚Ç¨<br>
                        Budget en attente: ${pendingBudget.toFixed(2)}‚Ç¨<br>
                        Total engag√©: ${totalEngaged.toFixed(2)}‚Ç¨<br>
                        Reste disponible: ${remainingBudget.toFixed(2)}‚Ç¨<br>
                        Pourcentage utilis√©: ${budget > 0 ? ((totalEngaged / budget) * 100).toFixed(1) : 0}%
                    </small>
                </div>
            `;
            
            document.getElementById('test-results').innerHTML = calculationHtml;
            log('‚úÖ Calcul du budget termin√©', 'success');
        }
        
        // Initialiser au chargement
        init();
    </script>
</body>
</html>

